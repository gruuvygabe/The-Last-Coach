<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>THE LAST COACH</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Your personal fitness tracker - Track progress photos, weight, and achieve your fitness goals">
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Last Coach">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- App Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 42px;
            margin-bottom: 10px;
        }

        .header .emoji {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: #666;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab.active {
            color: #FF6B35;
            border-bottom-color: #FF6B35;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            min-height: 48px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FF6B35;
        }

        .btn {
            background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            width: 100%;
            transition: transform 0.2s;
            margin-top: 10px;
            min-height: 48px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .step h2 {
            color: #FF6B35;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .step-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .option-card.selected {
            background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%);
            color: white;
            border-color: #1a1a1a;
        }

        .option-card .emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .option-card .label {
            font-weight: 600;
            font-size: 14px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .checkbox-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 48px;
        }

        .checkbox-item.selected {
            background: #ffe8df;
            border-color: #FF6B35;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FF6B35;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FF6B35;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #FF6B35;
            margin-top: 10px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            background: rgba(255,255,255,0.9);
            color: #FF6B35;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
            min-height: 48px;
            flex-shrink: 0;
        }

        .nav-tab.active {
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .photo-upload-area {
            border: 3px dashed #FF6B35;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .photo-upload-area:hover {
            background: #f8f9fa;
            border-color: #1a1a1a;
        }

        .progress-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-card {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photo-card:hover {
            transform: scale(1.05);
        }

        .photo-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .photo-info {
            padding: 10px;
            background: white;
        }

        .photo-date {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .photo-weight {
            font-size: 12px;
            color: #999;
        }

        .delete-photo {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 20px;
        }

        .comparison-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .comparison-card img {
            width: 100%;
            height: 400px;
            object-fit: cover;
        }

        .comparison-info {
            padding: 15px;
            text-align: center;
        }

        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .timeline-marker {
            width: 40px;
            height: 40px;
            background: #FF6B35;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .timeline-content {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: white;
            color: #333;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
        }

        .modal-close:hover {
            background: #f0f0f0;
        }

        @media (max-width: 768px) {
            .card {
                padding: 25px;
            }
            .two-column {
                grid-template-columns: 1fr;
            }
            .progress-photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            .header h1 {
                font-size: 32px;
            }
            .nav-tabs {
                gap: 5px;
            }
            .nav-tab {
                padding: 12px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Page -->
        <div id="loginPage" class="page active">
            <div class="header">
                <div class="emoji">üí™</div>
                <h1>THE LAST COACH</h1>
                <p>Your personalized fitness journey</p>
            </div>

            <div class="card">
                <div class="tabs">
                    <div class="tab active" onclick="switchAuthTab('signin')">Sign In</div>
                    <div class="tab" onclick="switchAuthTab('signup')">Sign Up</div>
                </div>

                <div id="authError" class="error-message"></div>

                <!-- Sign In -->
                <div id="signin" class="form-section active">
                    <form onsubmit="handleSignIn(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="signinEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="signinPassword" required>
                        </div>
                        <button type="submit" class="btn">Sign In</button>
                    </form>
                </div>

                <!-- Sign Up -->
                <div id="signup" class="form-section">
                    <form onsubmit="handleSignUp(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="signupEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="signupPassword" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="signupPasswordConfirm" required minlength="6">
                        </div>
                        <button type="submit" class="btn">Create Account</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Onboarding Page -->
        <div id="onboardingPage" class="page">
            <div class="header">
                <h1>üí™ THE LAST COACH</h1>
                <p>Let's create your personalized plan</p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="card" id="onboardingCard">
                <!-- Steps will be dynamically rendered -->
            </div>
        </div>
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page">
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h1 style="color: #FF6B35; font-size: 28px; margin: 0;">THE LAST COACH üí™</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <span id="userEmail" style="color: #666;"></span>
                    <button class="btn" style="width: auto; padding: 10px 20px; background: #6c757d; font-size: 14px; margin: 0;" onclick="showSettings()">‚öôÔ∏è Settings</button>
                    <button class="btn" style="width: auto; padding: 10px 20px; background: #ff6b6b; font-size: 14px; margin: 0;" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchDashTab('overview')">üìä Dashboard</button>
                <button class="nav-tab" onclick="switchDashTab('photos')">üì∏ Photos</button>
                <button class="nav-tab" onclick="switchDashTab('nutrition')">üçé Nutrition</button>
                <button class="nav-tab" onclick="switchDashTab('workouts')">üí™ Workouts</button>
            </div>

            <!-- Dashboard Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="card">
                    <h2 style="color: #FF6B35;">Welcome back, <span id="dashboardName">User</span>! üëã</h2>
                    <p style="color: #666; margin-top: 10px;">Here's your progress overview</p>
                </div>

                <div id="coachMessages" class="card" style="display: none;">
                    <h2 style="color: #FF6B35;">üí¨ Messages from Your Coach</h2>
                    <div id="userMessagesList"></div>
                </div>

                <div id="coachComments" class="card" style="display: none;">
                    <h2 style="color: #FF6B35;">üí™ Motivational Comments</h2>
                    <div id="userCommentsList"></div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="dashCurrentWeight">--</div>
                        <div class="stat-label">Current Weight (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dashGoalWeight">--</div>
                        <div class="stat-label">Goal Weight (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dashWeightToGo">--</div>
                        <div class="stat-label">Weight to Go (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dashTotalPhotos">0</div>
                        <div class="stat-label">Progress Photos</div>
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Your Personalized Plan</h2>
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #FF6B35;" id="dashCalories">--</div>
                            <div style="font-size: 14px; color: #666;">Daily Calories</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #FF6B35;" id="dashWorkouts">--</div>
                            <div style="font-size: 14px; color: #666;">Workouts/Week</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #FF6B35;" id="dashTDEE">--</div>
                            <div style="font-size: 14px; color: #666;">Maintenance Cals</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #ffe8df; border-radius: 10px; border-left: 4px solid #FF6B35;">
                        <strong style="color: #FF6B35;">Your Goals:</strong>
                        <div id="userGoals" style="margin-top: 10px; color: #333;"></div>
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Recent Progress Photos</h2>
                    <div id="recentPhotos" class="progress-photos-grid"></div>
                </div>
            </div>
            <!-- Progress Photos Tab -->
            <div id="photos" class="tab-content">
                <div class="card">
                    <h2 style="color: #FF6B35;">Upload Progress Photo</h2>
                    
                    <div class="photo-upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                        <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoSelect(event)">
                        <h3>üì∏ Click or Drag to Upload</h3>
                        <p>Take a new photo or select from gallery</p>
                    </div>

                    <div class="form-group">
                        <label>Current Weight (lbs)</label>
                        <input type="number" id="photoWeight" step="0.1" placeholder="Enter your current weight">
                    </div>

                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="photoNotes" rows="3" placeholder="How are you feeling? Any observations?"></textarea>
                    </div>

                    <button class="btn" onclick="saveProgressPhoto()">Save Progress Photo</button>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Before & After Comparison</h2>
                    <div class="form-group">
                        <label>Select First Photo</label>
                        <select id="beforePhoto" onchange="updateComparison()">
                            <option value="">Select a photo...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Select Second Photo</label>
                        <select id="afterPhoto" onchange="updateComparison()">
                            <option value="">Select a photo...</option>
                        </select>
                    </div>
                    <div id="comparisonView" class="comparison-view"></div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Progress Timeline</h2>
                    <div id="photoTimeline" class="timeline"></div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">All Progress Photos</h2>
                    <div id="allPhotos" class="progress-photos-grid"></div>
                </div>
            </div>

            <!-- Nutrition Tab -->
            <div id="nutrition" class="tab-content">
                <div class="card">
                    <h2 style="color: #FF6B35;">Nutrition Plan</h2>
                    <p>Your personalized meal plans coming soon...</p>
                </div>
            </div>

            <!-- Workouts Tab -->
            <div id="workouts" class="tab-content">
                <div class="card">
                    <h2 style="color: #FF6B35;">Workout Programs</h2>
                    <p>Your customized workout routines coming soon...</p>
                </div>
            </div>
        </div>
        <!-- Settings Modal -->
        <div id="settingsModal" class="modal" onclick="closeSettingsModal()">
            <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
                <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
                <div style="background: white; padding: 30px; border-radius: 15px; max-height: 80vh; overflow-y: auto;">
                    <h2 style="color: #FF6B35; margin-bottom: 20px;">‚öôÔ∏è Account Settings</h2>
                    
                    <div id="settingsError" class="error-message"></div>
                    <div id="settingsSuccess" style="background: #d4edda; color: #155724; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none;"></div>
                    
                    <h3 style="color: #333; margin-bottom: 15px;">Change Password</h3>
                    
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" placeholder="Enter current password">
                    </div>

                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password" minlength="6">
                    </div>

                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" placeholder="Confirm new password" minlength="6">
                    </div>

                    <button class="btn" onclick="changePassword()">Update Password</button>
                    
                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                    
                    <h3 style="color: #333; margin-bottom: 15px;">Account Information</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <strong>Email:</strong> <span id="settingsEmail"></span><br>
                        <strong>Member Since:</strong> <span id="settingsMemberSince"></span>
                    </div>

                    <button class="btn btn-secondary" onclick="closeSettingsModal()" style="margin-top: 20px;">Close</button>
                </div>
            </div>
        </div>

        <!-- Photo Modal -->
        <div id="photoModal" class="modal" onclick="closePhotoModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closePhotoModal()">√ó</button>
                <img id="modalImage" src="" alt="Progress Photo">
            </div>
        </div>
    </div>

    <script>
        // Global State
        let currentUser = null;
        let currentPage = 'login';
        let currentStep = 1;
        const totalSteps = 8;
        const userData = {};
        let progressPhotos = [];
        let selectedPhotoFile = null;

        // Page Navigation
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            currentPage = pageName;
        }

        // Auth Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.getElementById('authError').style.display = 'none';
        }

        function handleSignIn(event) {
            event.preventDefault();
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            const users = JSON.parse(localStorage.getItem('users') || '{}');

            // Check for admin credentials
            if (email === 'admin@thelastcoach.com' && password === 'admin123') {
                currentUser = {
                    email: email,
                    isAdmin: true,
                    name: 'Admin',
                    onboardingComplete: true
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                loadAdminDashboard();
                showPage('dashboard');
                return;
            }

            if (!users[email]) {
                showAuthError('No account found. Please sign up first.');
                return;
            }

            if (users[email].password !== password) {
                showAuthError('Incorrect password.');
                return;
            }

            currentUser = users[email];
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            if (currentUser.onboardingComplete) {
                loadDashboard();
                showPage('dashboard');
            } else {
                startOnboarding();
                showPage('onboarding');
            }
        }

        function handleSignUp(event) {
            event.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showAuthError('Passwords do not match.');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');

            if (users[email]) {
                showAuthError('Account already exists. Please sign in.');
                return;
            }

            const newUser = {
                email: email,
                password: password,
                createdAt: new Date().toISOString(),
                onboardingComplete: false
            };

            users[email] = newUser;
            localStorage.setItem('users', JSON.stringify(users));
            currentUser = newUser;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            startOnboarding();
            showPage('onboarding');
        }

        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                showPage('login');
            }
        }

        // Onboarding Functions
        function startOnboarding() {
            currentStep = 1;
            updateProgress();
            renderOnboardingStep();
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function renderOnboardingStep() {
            const card = document.getElementById('onboardingCard');
            
            if (currentStep === 1) {
                // Step 1: Basic Info
                card.innerHTML = `
                    <h2>Welcome! Let's start with the basics</h2>
                    <p class="step-subtitle">This helps us understand where you're starting from</p>
                    
                    <div class="form-group">
                        <label>What's your name?</label>
                        <input type="text" id="userName" placeholder="Enter your first name" value="${userData.name || ''}">
                    </div>

                    <div class="two-column">
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" id="userAge" placeholder="Years" value="${userData.age || ''}">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="userGender">
                                <option value="">Select...</option>
                                <option value="male" ${userData.gender === 'male' ? 'selected' : ''}>Male</option>
                                <option value="female" ${userData.gender === 'female' ? 'selected' : ''}>Female</option>
                                <option value="other" ${userData.gender === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="two-column">
                        <div class="form-group">
                            <label>Height (feet)</label>
                            <input type="number" id="heightFeet" placeholder="5" min="3" max="8" value="${userData.heightFeet || ''}">
                        </div>
                        <div class="form-group">
                            <label>Height (inches)</label>
                            <input type="number" id="heightInches" placeholder="10" min="0" max="11" value="${userData.heightInches || ''}">
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                `;
            } else if (currentStep === 2) {
                // Step 2: Current Fitness
                card.innerHTML = `
                    <h2>Tell us about your current fitness</h2>
                    <p class="step-subtitle">Be honest - this helps us create a safe and effective plan</p>

                    <div class="form-group">
                        <label>Current Weight (lbs)</label>
                        <input type="number" id="currentWeight" step="0.1" placeholder="Enter your current weight" value="${userData.currentWeight || ''}">
                    </div>

                    <div class="form-group">
                        <label>What's your current activity level?</label>
                        <div class="options-grid">
                            <div class="option-card ${userData.activityLevel === 'sedentary' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'sedentary', this)">
                                <div class="emoji">üõãÔ∏è</div>
                                <div class="label">Sedentary</div>
                                <small>Little to no exercise</small>
                            </div>
                            <div class="option-card ${userData.activityLevel === 'light' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'light', this)">
                                <div class="emoji">üö∂</div>
                                <div class="label">Lightly Active</div>
                                <small>1-3 days/week</small>
                            </div>
                            <div class="option-card ${userData.activityLevel === 'moderate' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'moderate', this)">
                                <div class="emoji">üèÉ</div>
                                <div class="label">Moderately Active</div>
                                <small>3-5 days/week</small>
                            </div>
                            <div class="option-card ${userData.activityLevel === 'very' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'very', this)">
                                <div class="emoji">üí™</div>
                                <div class="label">Very Active</div>
                                <small>6-7 days/week</small>
                            </div>
                            <div class="option-card ${userData.activityLevel === 'extreme' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'extreme', this)">
                                <div class="emoji">üèãÔ∏è</div>
                                <div class="label">Extremely Active</div>
                                <small>Athlete/physical job</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>How would you describe your current fitness level?</label>
                        <div class="options-grid">
                            <div class="option-card ${userData.fitnessLevel === 'beginner' ? 'selected' : ''}" onclick="selectOption('fitnessLevel', 'beginner', this)">
                                <div class="emoji">üå±</div>
                                <div class="label">Beginner</div>
                                <small>Just starting out</small>
                            </div>
                            <div class="option-card ${userData.fitnessLevel === 'intermediate' ? 'selected' : ''}" onclick="selectOption('fitnessLevel', 'intermediate', this)">
                                <div class="emoji">üåø</div>
                                <div class="label">Intermediate</div>
                                <small>Some experience</small>
                            </div>
                            <div class="option-card ${userData.fitnessLevel === 'advanced' ? 'selected' : ''}" onclick="selectOption('fitnessLevel', 'advanced', this)">
                                <div class="emoji">üå≥</div>
                                <div class="label">Advanced</div>
                                <small>Very experienced</small>
                            </div>
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
            } else if (currentStep === 3) {
                // Step 3: Goals
                card.innerHTML = `
                    <h2>What are your goals?</h2>
                    <p class="step-subtitle">Select all that apply - we'll create a plan that addresses everything</p>

                    <div class="form-group">
                        <label>Primary Goals (select all that apply)</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item ${userData.goals && userData.goals.includes('weight-loss') ? 'selected' : ''}" onclick="toggleGoal('weight-loss', this)">
                                <input type="checkbox" ${userData.goals && userData.goals.includes('weight-loss') ? 'checked' : ''}> üéØ Weight Loss
                            </div>
                            <div class="checkbox-item ${userData.goals && userData.goals.includes('muscle-gain') ? 'selected' : ''}" onclick="toggleGoal('muscle-gain', this)">
                                <input type="checkbox" ${userData.goals && userData.goals.includes('muscle-gain') ? 'checked' : ''}> üí™ Build Muscle
                            </div>
                            <div class="checkbox-item ${userData.goals && userData.goals.includes('strength') ? 'selected' : ''}" onclick="toggleGoal('strength', this)">
                                <input type="checkbox" ${userData.goals && userData.goals.includes('strength') ? 'checked' : ''}> üèãÔ∏è Get Stronger
                            </div>
                            <div class="checkbox-item ${userData.goals && userData.goals.includes('endurance') ? 'selected' : ''}" onclick="toggleGoal('endurance', this)">
                                <input type="checkbox" ${userData.goals && userData.goals.includes('endurance') ? 'checked' : ''}> üèÉ Improve Endurance
                            </div>
                            <div class="checkbox-item ${userData.goals && userData.goals.includes('tone') ? 'selected' : ''}" onclick="toggleGoal('tone', this)">
                                <input type="checkbox" ${userData.goals && userData.goals.includes('tone') ? 'checked' : ''}> ‚ú® Tone Up
                            </div>
                            <div class="checkbox-item ${userData.goals && userData.goals.includes('health') ? 'selected' : ''}" onclick="toggleGoal('health', this)">
                                <input type="checkbox" ${userData.goals && userData.goals.includes('health') ? 'checked' : ''}> ‚ù§Ô∏è General Health
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Goal Weight (lbs)</label>
                        <input type="number" id="goalWeight" step="0.1" placeholder="Your target weight" value="${userData.goalWeight || ''}">
                    </div>

                    <div class="form-group">
                        <label>Timeline: How soon do you want to reach your goal?</label>
                        <select id="timeline">
                            <option value="">Select timeline...</option>
                            <option value="3" ${userData.timeline === '3' ? 'selected' : ''}>3 months</option>
                            <option value="6" ${userData.timeline === '6' ? 'selected' : ''}>6 months</option>
                            <option value="12" ${userData.timeline === '12' ? 'selected' : ''}>1 year</option>
                            <option value="24" ${userData.timeline === '24' ? 'selected' : ''}>2 years</option>
                        </select>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
            } else if (currentStep === 4) {
                // Step 4: Workout Preferences
                card.innerHTML = `
                    <h2>Workout Preferences</h2>
                    <p class="step-subtitle">Help us design workouts you'll actually enjoy</p>

                    <div class="form-group">
                        <label>How many days per week can you work out?</label>
                        <div class="slider-container">
                            <input type="range" min="2" max="7" value="${userData.workoutDays || 4}" class="slider" id="workoutDays" oninput="updateSlider('workoutDays', 'workoutDaysValue', ' days/week')">
                            <div class="slider-value" id="workoutDaysValue">${userData.workoutDays || 4} days/week</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>How long can you work out each session?</label>
                        <div class="slider-container">
                            <input type="range" min="15" max="120" step="15" value="${userData.workoutDuration || 45}" class="slider" id="workoutDuration" oninput="updateSlider('workoutDuration', 'workoutDurationValue', ' minutes')">
                            <div class="slider-value" id="workoutDurationValue">${userData.workoutDuration || 45} minutes</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Where will you work out?</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item ${userData.workoutLocations && userData.workoutLocations.includes('home') ? 'selected' : ''}" onclick="toggleCheckbox('workoutLocations', 'home', this)">
                                <input type="checkbox" ${userData.workoutLocations && userData.workoutLocations.includes('home') ? 'checked' : ''}> üè† Home
                            </div>
                            <div class="checkbox-item ${userData.workoutLocations && userData.workoutLocations.includes('gym') ? 'selected' : ''}" onclick="toggleCheckbox('workoutLocations', 'gym', this)">
                                <input type="checkbox" ${userData.workoutLocations && userData.workoutLocations.includes('gym') ? 'checked' : ''}> üèãÔ∏è Gym
                            </div>
                            <div class="checkbox-item ${userData.workoutLocations && userData.workoutLocations.includes('outdoor') ? 'selected' : ''}" onclick="toggleCheckbox('workoutLocations', 'outdoor', this)">
                                <input type="checkbox" ${userData.workoutLocations && userData.workoutLocations.includes('outdoor') ? 'checked' : ''}> üå≥ Outdoors
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>What equipment do you have access to?</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item ${userData.equipment && userData.equipment.includes('bodyweight') ? 'selected' : ''}" onclick="toggleCheckbox('equipment', 'bodyweight', this)">
                                <input type="checkbox" ${userData.equipment && userData.equipment.includes('bodyweight') ? 'checked' : ''}> ü§∏ Bodyweight Only
                            </div>
                            <div class="checkbox-item ${userData.equipment && userData.equipment.includes('dumbbells') ? 'selected' : ''}" onclick="toggleCheckbox('equipment', 'dumbbells', this)">
                                <input type="checkbox" ${userData.equipment && userData.equipment.includes('dumbbells') ? 'checked' : ''}> üèãÔ∏è Dumbbells
                            </div>
                            <div class="checkbox-item ${userData.equipment && userData.equipment.includes('barbells') ? 'selected' : ''}" onclick="toggleCheckbox('equipment', 'barbells', this)">
                                <input type="checkbox" ${userData.equipment && userData.equipment.includes('barbells') ? 'checked' : ''}> üèãÔ∏è Barbells
                            </div>
                            <div class="checkbox-item ${userData.equipment && userData.equipment.includes('resistance-bands') ? 'selected' : ''}" onclick="toggleCheckbox('equipment', 'resistance-bands', this)">
                                <input type="checkbox" ${userData.equipment && userData.equipment.includes('resistance-bands') ? 'checked' : ''}> üéØ Resistance Bands
                            </div>
                            <div class="checkbox-item ${userData.equipment && userData.equipment.includes('full-gym') ? 'selected' : ''}" onclick="toggleCheckbox('equipment', 'full-gym', this)">
                                <input type="checkbox" ${userData.equipment && userData.equipment.includes('full-gym') ? 'checked' : ''}> üè¢ Full Gym Access
                            </div>
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
                updateSlider('workoutDays', 'workoutDaysValue', ' days/week');
                updateSlider('workoutDuration', 'workoutDurationValue', ' minutes');
            }
 else if (currentStep === 5) {
                // Step 5: Nutrition
                card.innerHTML = `
                    <h2>Nutrition Preferences</h2>
                    <p class="step-subtitle">Let's personalize your meal planning</p>

                    <div class="form-group">
                        <label>Dietary preferences</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item ${userData.dietTypes && userData.dietTypes.includes('none') ? 'selected' : ''}" onclick="toggleCheckbox('dietTypes', 'none', this)">
                                <input type="checkbox" ${userData.dietTypes && userData.dietTypes.includes('none') ? 'checked' : ''}> No restrictions
                            </div>
                            <div class="checkbox-item ${userData.dietTypes && userData.dietTypes.includes('vegetarian') ? 'selected' : ''}" onclick="toggleCheckbox('dietTypes', 'vegetarian', this)">
                                <input type="checkbox" ${userData.dietTypes && userData.dietTypes.includes('vegetarian') ? 'checked' : ''}> Vegetarian
                            </div>
                            <div class="checkbox-item ${userData.dietTypes && userData.dietTypes.includes('vegan') ? 'selected' : ''}" onclick="toggleCheckbox('dietTypes', 'vegan', this)">
                                <input type="checkbox" ${userData.dietTypes && userData.dietTypes.includes('vegan') ? 'checked' : ''}> Vegan
                            </div>
                            <div class="checkbox-item ${userData.dietTypes && userData.dietTypes.includes('keto') ? 'selected' : ''}" onclick="toggleCheckbox('dietTypes', 'keto', this)">
                                <input type="checkbox" ${userData.dietTypes && userData.dietTypes.includes('keto') ? 'checked' : ''}> Keto
                            </div>
                            <div class="checkbox-item ${userData.dietTypes && userData.dietTypes.includes('paleo') ? 'selected' : ''}" onclick="toggleCheckbox('dietTypes', 'paleo', this)">
                                <input type="checkbox" ${userData.dietTypes && userData.dietTypes.includes('paleo') ? 'checked' : ''}> Paleo
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Food allergies or restrictions</label>
                        <textarea id="allergies" rows="3" placeholder="e.g., nuts, dairy, gluten...">${userData.allergies || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>How many meals do you prefer per day?</label>
                        <div class="slider-container">
                            <input type="range" min="2" max="6" value="${userData.mealsPerDay || 3}" class="slider" id="mealsPerDay" oninput="updateSlider('mealsPerDay', 'mealsPerDayValue', ' meals')">
                            <div class="slider-value" id="mealsPerDayValue">${userData.mealsPerDay || 3} meals</div>
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
                updateSlider('mealsPerDay', 'mealsPerDayValue', ' meals');
            } else if (currentStep === 6) {
                // Step 6: Lifestyle
                card.innerHTML = `
                    <h2>Lifestyle & Schedule</h2>
                    <p class="step-subtitle">Help us fit fitness into your life</p>

                    <div class="form-group">
                        <label>What's your work schedule like?</label>
                        <select id="workSchedule">
                            <option value="">Select...</option>
                            <option value="9-5" ${userData.workSchedule === '9-5' ? 'selected' : ''}>Regular 9-5</option>
                            <option value="shifts" ${userData.workSchedule === 'shifts' ? 'selected' : ''}>Shift work</option>
                            <option value="flexible" ${userData.workSchedule === 'flexible' ? 'selected' : ''}>Flexible</option>
                            <option value="irregular" ${userData.workSchedule === 'irregular' ? 'selected' : ''}>Irregular</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>When do you prefer to work out?</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item ${userData.workoutTimes && userData.workoutTimes.includes('morning') ? 'selected' : ''}" onclick="toggleCheckbox('workoutTimes', 'morning', this)">
                                <input type="checkbox" ${userData.workoutTimes && userData.workoutTimes.includes('morning') ? 'checked' : ''}> üåÖ Morning
                            </div>
                            <div class="checkbox-item ${userData.workoutTimes && userData.workoutTimes.includes('afternoon') ? 'selected' : ''}" onclick="toggleCheckbox('workoutTimes', 'afternoon', this)">
                                <input type="checkbox" ${userData.workoutTimes && userData.workoutTimes.includes('afternoon') ? 'checked' : ''}> ‚òÄÔ∏è Afternoon
                            </div>
                            <div class="checkbox-item ${userData.workoutTimes && userData.workoutTimes.includes('evening') ? 'selected' : ''}" onclick="toggleCheckbox('workoutTimes', 'evening', this)">
                                <input type="checkbox" ${userData.workoutTimes && userData.workoutTimes.includes('evening') ? 'checked' : ''}> üåô Evening
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Average sleep per night</label>
                        <div class="slider-container">
                            <input type="range" min="4" max="12" value="${userData.sleepHours || 7}" class="slider" id="sleepHours" oninput="updateSlider('sleepHours', 'sleepHoursValue', ' hours')">
                            <div class="slider-value" id="sleepHoursValue">${userData.sleepHours || 7} hours</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Stress level</label>
                        <div class="slider-container">
                            <input type="range" min="1" max="10" value="${userData.stressLevel || 5}" class="slider" id="stressLevel" oninput="updateSlider('stressLevel', 'stressLevelValue', '/10')">
                            <div class="slider-value" id="stressLevelValue">${userData.stressLevel || 5}/10</div>
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
                updateSlider('sleepHours', 'sleepHoursValue', ' hours');
                updateSlider('stressLevel', 'stressLevelValue', '/10');
            } else if (currentStep === 7) {
                // Step 7: Motivation
                card.innerHTML = `
                    <h2>Your Motivation</h2>
                    <p class="step-subtitle">Understanding your "why" helps keep you accountable</p>

                    <div class="form-group">
                        <label>What's your primary motivation for this transformation?</label>
                        <textarea id="motivation" rows="4" placeholder="Be specific... What will achieving your goals mean for you?">${userData.motivation || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>What has stopped you in the past?</label>
                        <textarea id="pastBarriers" rows="3" placeholder="e.g., lack of time, motivation, injuries...">${userData.pastBarriers || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>How do you learn best?</label>
                        <select id="learningStyle">
                            <option value="">Select...</option>
                            <option value="visual" ${userData.learningStyle === 'visual' ? 'selected' : ''}>Visual (videos, demos)</option>
                            <option value="written" ${userData.learningStyle === 'written' ? 'selected' : ''}>Written (instructions, guides)</option>
                            <option value="both" ${userData.learningStyle === 'both' ? 'selected' : ''}>Both</option>
                        </select>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
            } else if (currentStep === 8) {
                // Step 8: Medical & Final
                card.innerHTML = `
                    <h2>Medical History & Final Details</h2>
                    <p class="step-subtitle">Help us keep you safe and healthy</p>

                    <div class="form-group">
                        <label>Any injuries or physical limitations?</label>
                        <textarea id="injuries" rows="3" placeholder="e.g., knee problems, back pain, etc.">${userData.injuries || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Any medical conditions we should know about?</label>
                        <textarea id="conditions" rows="3" placeholder="e.g., diabetes, heart condition, etc.">${userData.conditions || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Have you worked with a coach before?</label>
                        <select id="previousCoaching">
                            <option value="">Select...</option>
                            <option value="yes" ${userData.previousCoaching === 'yes' ? 'selected' : ''}>Yes</option>
                            <option value="no" ${userData.previousCoaching === 'no' ? 'selected' : ''}>No</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Anything else you'd like us to know?</label>
                        <textarea id="additionalNotes" rows="3" placeholder="Any other information that might help...">${userData.additionalNotes || ''}</textarea>
                    </div>

                    <button class="btn" onclick="completeOnboarding()">Complete Setup üéâ</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
            }
        }

        function selectOption(field, value, element) {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            userData[field] = value;
        }

        function toggleGoal(goal, element) {
            if (!userData.goals) userData.goals = [];
            const index = userData.goals.indexOf(goal);
            if (index > -1) {
                userData.goals.splice(index, 1);
                element.classList.remove('selected');
                element.querySelector('input').checked = false;
            } else {
                userData.goals.push(goal);
                element.classList.add('selected');
                element.querySelector('input').checked = true;
            }
        }

        function toggleCheckbox(field, value, element) {
            if (!userData[field]) userData[field] = [];
            const index = userData[field].indexOf(value);
            if (index > -1) {
                userData[field].splice(index, 1);
                element.classList.remove('selected');
                element.querySelector('input').checked = false;
            } else {
                userData[field].push(value);
                element.classList.add('selected');
                element.querySelector('input').checked = true;
            }
        }

        function updateSlider(sliderId, valueId, suffix) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            if (slider && valueDisplay) {
                valueDisplay.textContent = slider.value + suffix;
            }
        }

        function nextOnboardingStep() {
            // Save current step data
            if (currentStep === 1) {
                userData.name = document.getElementById('userName').value;
                userData.age = document.getElementById('userAge').value;
                userData.gender = document.getElementById('userGender').value;
                userData.heightFeet = document.getElementById('heightFeet').value;
                userData.heightInches = document.getElementById('heightInches').value;

                if (!userData.name || !userData.age || !userData.gender || !userData.heightFeet || !userData.heightInches) {
                    alert('Please fill in all fields');
                    return;
                }
            } else if (currentStep === 2) {
                userData.currentWeight = document.getElementById('currentWeight').value;

                if (!userData.currentWeight || !userData.activityLevel || !userData.fitnessLevel) {
                    alert('Please fill in all fields');
                    return;
                }
            } else if (currentStep === 3) {
                userData.goalWeight = document.getElementById('goalWeight').value;
                userData.timeline = document.getElementById('timeline').value;

                if (!userData.goalWeight || !userData.timeline || !userData.goals || userData.goals.length === 0) {
                    alert('Please fill in all fields and select at least one goal');
                    return;
                }
            } else if (currentStep === 4) {
                userData.workoutDays = document.getElementById('workoutDays').value;
                userData.workoutDuration = document.getElementById('workoutDuration').value;

                if (!userData.workoutLocations || userData.workoutLocations.length === 0 || !userData.equipment || userData.equipment.length === 0) {
                    alert('Please select where you\'ll work out and what equipment you have');
                    return;
                }
            } else if (currentStep === 5) {
                userData.allergies = document.getElementById('allergies').value;
                userData.mealsPerDay = document.getElementById('mealsPerDay').value;

                if (!userData.dietTypes || userData.dietTypes.length === 0) {
                    alert('Please select your dietary preferences');
                    return;
                }
            } else if (currentStep === 6) {
                userData.workSchedule = document.getElementById('workSchedule').value;
                userData.sleepHours = document.getElementById('sleepHours').value;
                userData.stressLevel = document.getElementById('stressLevel').value;

                if (!userData.workSchedule || !userData.workoutTimes || userData.workoutTimes.length === 0) {
                    alert('Please fill in all fields');
                    return;
                }
            } else if (currentStep === 7) {
                userData.motivation = document.getElementById('motivation').value;
                userData.pastBarriers = document.getElementById('pastBarriers').value;
                userData.learningStyle = document.getElementById('learningStyle').value;

                if (!userData.motivation || !userData.learningStyle) {
                    alert('Please fill in your motivation and learning style');
                    return;
                }
            }

            currentStep++;
            updateProgress();
            renderOnboardingStep();
        }

        function prevOnboardingStep() {
            currentStep--;
            updateProgress();
            renderOnboardingStep();
        }

        function completeOnboarding() {
            console.log('Complete onboarding called');
            
            // Save Step 8 data
            userData.injuries = document.getElementById('injuries').value;
            userData.conditions = document.getElementById('conditions').value;
            userData.previousCoaching = document.getElementById('previousCoaching').value;
            userData.additionalNotes = document.getElementById('additionalNotes').value;

            // Calculate BMR and TDEE
            const heightInInches = (parseInt(userData.heightFeet) * 12) + parseInt(userData.heightInches);
            const weightInKg = userData.currentWeight * 0.453592;
            const heightInCm = heightInInches * 2.54;
            const age = parseInt(userData.age);

            // Mifflin-St Jeor Equation
            let bmr;
            if (userData.gender === 'male') {
                bmr = (10 * weightInKg) + (6.25 * heightInCm) - (5 * age) + 5;
            } else {
                bmr = (10 * weightInKg) + (6.25 * heightInCm) - (5 * age) - 161;
            }

            // Activity multiplier
            const activityMultipliers = {
                'sedentary': 1.2,
                'light': 1.375,
                'moderate': 1.55,
                'very': 1.725,
                'extreme': 1.9
            };

            const tdee = Math.round(bmr * activityMultipliers[userData.activityLevel]);
            userData.bmr = Math.round(bmr);
            userData.tdee = tdee;

            // Calculate calorie target based on goals
            const weightDiff = userData.currentWeight - userData.goalWeight;
            if (weightDiff > 0) {
                // Weight loss
                userData.calorieTarget = tdee - 500;
            } else if (weightDiff < 0) {
                // Weight gain
                userData.calorieTarget = tdee + 300;
            } else {
                // Maintenance
                userData.calorieTarget = tdee;
            }

            userData.onboardingComplete = true;

            // Update user
            currentUser = { ...currentUser, ...userData };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            users[currentUser.email] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));

            console.log('Loading dashboard...');
            
            try {
                loadDashboard();
                showPage('dashboard');
                console.log('Dashboard loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function loadDashboard() {
            try {
                // Safely set dashboard values with null checks
                const nameEl = document.getElementById('dashboardName');
                if (nameEl) nameEl.textContent = currentUser.name || 'User';
                
                const currentWeightEl = document.getElementById('dashCurrentWeight');
                if (currentWeightEl) currentWeightEl.textContent = currentUser.currentWeight || '--';
                
                const goalWeightEl = document.getElementById('dashGoalWeight');
                if (goalWeightEl) goalWeightEl.textContent = currentUser.goalWeight || '--';
                
                const caloriesEl = document.getElementById('dashCalories');
                if (caloriesEl) caloriesEl.textContent = currentUser.calorieTarget || '--';
                
                const workoutsEl = document.getElementById('dashWorkouts');
                if (workoutsEl) workoutsEl.textContent = currentUser.workoutDays || '--';
                
                const emailEl = document.getElementById('userEmail');
                if (emailEl) emailEl.textContent = currentUser.email || '';
                
                // Calculate weight to go
                if (currentUser.currentWeight && currentUser.goalWeight) {
                    const weightToGo = Math.abs(currentUser.currentWeight - currentUser.goalWeight).toFixed(1);
                    const weightToGoEl = document.getElementById('dashWeightToGo');
                    if (weightToGoEl) weightToGoEl.textContent = weightToGo;
                }
                
                // Load messages from coach
                try {
                    loadUserMessages();
                } catch (msgError) {
                    console.log('Messages not loaded:', msgError);
                }
                
                // Load progress photos
                try {
                    loadProgressPhotos();
                    setupPhotoUpload();
                } catch (photoError) {
                    console.log('Photos not loaded:', photoError);
                }
            } catch (error) {
                console.error('Dashboard loading error:', error);
                // Don't show alert - just log it
                // Continue anyway - partial dashboard is better than nothing
            }
        }

        function loadUserMessages() {
            // Load messages
            const userMessages = localStorage.getItem(`messages_${currentUser.email}`);
            const messages = userMessages ? JSON.parse(userMessages) : [];
            
            // Load comments
            const userComments = localStorage.getItem(`comments_${currentUser.email}`);
            const comments = userComments ? JSON.parse(userComments) : [];

            // Show messages if any exist
            if (messages.length > 0) {
                const messagesCard = document.getElementById('coachMessages');
                messagesCard.style.display = 'block';
                
                const unreadMessages = messages.filter(m => !m.read);
                
                document.getElementById('userMessagesList').innerHTML = messages.slice(-5).reverse().map(msg => `
                    <div style="background: ${msg.read ? '#f8f9fa' : '#e3e8ff'}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #FF6B35;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #FF6B35;">${msg.type.toUpperCase()}</strong>
                            <small style="color: #666;">${new Date(msg.date).toLocaleDateString()}</small>
                        </div>
                        <p style="margin-top: 10px; color: #333;">${msg.message}</p>
                        ${!msg.read ? '<span style="color: #FF6B35; font-weight: bold; font-size: 12px;">NEW</span>' : ''}
                    </div>
                `).join('');
                
                // Mark messages as read
                messages.forEach(m => m.read = true);
                localStorage.setItem(`messages_${currentUser.email}`, JSON.stringify(messages));
            }

            // Show comments if any exist
            if (comments.length > 0) {
                const commentsCard = document.getElementById('coachComments');
                commentsCard.style.display = 'block';
                
                document.getElementById('userCommentsList').innerHTML = comments.slice(-5).reverse().map(comment => `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #FF6B35;">Your Coach</strong>
                            <small style="color: #666;">${new Date(comment.date).toLocaleDateString()}</small>
                        </div>
                        <p style="margin-top: 10px; color: #333;">${comment.comment}</p>
                    </div>
                `).join('');
            }
        }

        function loadAdminDashboard() {
            document.getElementById('userEmail').textContent = 'admin@thelastcoach.com';
            
            // Get all users
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const userList = Object.values(users);
            
            // Update dashboard with admin stats
            document.getElementById('dashboardName').textContent = 'Admin';
            document.getElementById('dashCurrentWeight').textContent = userList.length;
            document.querySelector('#dashCurrentWeight').parentElement.querySelector('.stat-label').textContent = 'Total Users';
            
            const completedUsers = userList.filter(u => u.onboardingComplete).length;
            document.getElementById('dashGoalWeight').textContent = completedUsers;
            document.querySelector('#dashGoalWeight').parentElement.querySelector('.stat-label').textContent = 'Completed Onboarding';
            
            const totalPhotos = userList.reduce((sum, user) => {
                const photos = localStorage.getItem(`photos_${user.email}`);
                return sum + (photos ? JSON.parse(photos).length : 0);
            }, 0);
            document.getElementById('dashWeightToGo').textContent = totalPhotos;
            document.querySelector('#dashWeightToGo').parentElement.querySelector('.stat-label').textContent = 'Total Photos';
            
            document.getElementById('dashTotalPhotos').textContent = userList.length > 0 ? '‚úì' : '0';
            document.querySelector('#dashTotalPhotos').parentElement.querySelector('.stat-label').textContent = 'System Active';
            
            // Show user list with management options
            const recentPhotos = document.getElementById('recentPhotos');
            recentPhotos.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;"><h3 style="margin-bottom: 15px; color: #FF6B35;">All Users</h3>' + 
                userList.map(user => {
                    const userPhotos = localStorage.getItem(`photos_${user.email}`);
                    const photoCount = userPhotos ? JSON.parse(userPhotos).length : 0;
                    
                    return `
                    <div style="padding: 15px; background: white; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #FF6B35;">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                            <div style="flex: 1;">
                                <strong>${user.name || 'No name'}</strong> (${user.email})<br>
                                <small style="color: #666;">
                                    ${user.onboardingComplete ? '‚úÖ Onboarding Complete' : '‚è≥ Onboarding Incomplete'}<br>
                                    Weight: ${user.currentWeight || 'N/A'} lbs ‚Üí ${user.goalWeight || 'N/A'} lbs<br>
                                    Photos: ${photoCount}<br>
                                    Joined: ${new Date(user.createdAt).toLocaleDateString()}
                                </small>
                            </div>
                            <button class="btn" style="width: auto; padding: 10px 20px; margin: 0; font-size: 14px;" 
                                    onclick="viewUserDetails('${user.email}')">
                                View Profile
                            </button>
                        </div>
                    </div>
                `;
                }).join('') + '</div>';
            
            // Hide photo upload for admin
            document.querySelector('[onclick="switchDashTab(\'photos\')"]').style.display = 'none';
        }

        function viewUserDetails(email) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[email];
            
            if (!user) {
                alert('User not found');
                return;
            }

            // Load user's photos
            const userPhotos = localStorage.getItem(`photos_${email}`);
            const photos = userPhotos ? JSON.parse(userPhotos) : [];
            
            // Load user's messages
            const userMessages = localStorage.getItem(`messages_${email}`);
            const messages = userMessages ? JSON.parse(userMessages) : [];

            // Show user detail view
            const overview = document.getElementById('overview');
            overview.innerHTML = `
                <div class="card">
                    <button class="btn btn-secondary" style="width: auto; padding: 10px 20px; margin-bottom: 20px;" onclick="loadAdminDashboard(); loadDashboard();">
                        ‚Üê Back to All Users
                    </button>
                    <h2 style="color: #FF6B35;">Managing: ${user.name || 'User'}</h2>
                    <p style="color: #666; margin-top: 10px;">${user.email}</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${user.currentWeight || '--'}</div>
                        <div class="stat-label">Current Weight (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${user.goalWeight || '--'}</div>
                        <div class="stat-label">Goal Weight (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${user.currentWeight && user.goalWeight ? Math.abs(user.currentWeight - user.goalWeight).toFixed(1) : '--'}</div>
                        <div class="stat-label">Weight to Go (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${photos.length}</div>
                        <div class="stat-label">Progress Photos</div>
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">User Details</h2>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px;">
                        <strong>Personal Info:</strong><br>
                        Age: ${user.age || 'N/A'}<br>
                        Gender: ${user.gender || 'N/A'}<br>
                        Height: ${user.heightFeet || 'N/A'}' ${user.heightInches || 'N/A'}"<br><br>
                        <strong>Goals:</strong><br>
                        Primary Goal: ${user.primaryGoal || 'N/A'}<br>
                        Workouts/Week: ${user.workoutDays || 'N/A'}<br>
                        Calories: ${user.calorieTarget || 'N/A'}<br><br>
                        <strong>Motivation:</strong><br>
                        "${user.motivation || 'Not provided'}"
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Send Message to ${user.name || 'User'}</h2>
                    <div class="form-group">
                        <label>Message Type</label>
                        <select id="messageType">
                            <option value="motivation">Motivational Message</option>
                            <option value="checkin">Check-in</option>
                            <option value="congrats">Congratulations</option>
                            <option value="general">General Message</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Your Message</label>
                        <textarea id="adminMessage" rows="4" placeholder="Write your message here..."></textarea>
                    </div>
                    <button class="btn" onclick="sendMessageToUser('${email}')">Send Message</button>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Message History</h2>
                    <div id="messageHistory">
                        ${messages.length === 0 ? 
                            '<p style="color: #999; text-align: center;">No messages sent yet</p>' :
                            messages.map(msg => `
                                <div style="background: #e3e8ff; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #FF6B35;">
                                    <strong style="color: #FF6B35;">${msg.type.toUpperCase()}</strong>
                                    <small style="color: #666; float: right;">${new Date(msg.date).toLocaleString()}</small>
                                    <p style="margin-top: 10px; color: #333;">${msg.message}</p>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">${user.name || 'User'}'s Progress Photos</h2>
                    <div class="progress-photos-grid">
                        ${photos.length === 0 ? 
                            '<p style="color: #999; text-align: center;">No photos uploaded yet</p>' :
                            photos.map(photo => `
                                <div class="photo-card" onclick="openPhotoModal('${photo.imageData}')">
                                    <img src="${photo.imageData}" alt="Progress photo">
                                    <div class="photo-info">
                                        <div class="photo-date">${new Date(photo.date).toLocaleDateString()}</div>
                                        <div class="photo-weight">${photo.weight} lbs</div>
                                        ${photo.notes ? `<small style="color: #666;">${photo.notes}</small>` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Leave Motivational Comment</h2>
                    <div class="form-group">
                        <label>Your Comment</label>
                        <textarea id="motivationalComment" rows="3" placeholder="Leave an encouraging comment on their progress..."></textarea>
                    </div>
                    <button class="btn" onclick="addMotivationalComment('${email}')">Post Comment</button>
                    
                    <div id="commentsList" style="margin-top: 20px;">
                        ${getMotivationalComments(email)}
                    </div>
                </div>
            `;
        }

        function sendMessageToUser(email) {
            const messageType = document.getElementById('messageType').value;
            const messageText = document.getElementById('adminMessage').value;

            if (!messageText.trim()) {
                alert('Please enter a message');
                return;
            }

            // Get existing messages
            const userMessages = localStorage.getItem(`messages_${email}`);
            const messages = userMessages ? JSON.parse(userMessages) : [];

            // Add new message
            const newMessage = {
                id: Date.now(),
                type: messageType,
                message: messageText,
                date: new Date().toISOString(),
                read: false
            };

            messages.push(newMessage);
            localStorage.setItem(`messages_${email}`, JSON.stringify(messages));

            // Clear form
            document.getElementById('adminMessage').value = '';

            alert('Message sent successfully!');
            
            // Refresh the view
            viewUserDetails(email);
        }

        function addMotivationalComment(email) {
            const commentText = document.getElementById('motivationalComment').value;

            if (!commentText.trim()) {
                alert('Please enter a comment');
                return;
            }

            // Get existing comments
            const userComments = localStorage.getItem(`comments_${email}`);
            const comments = userComments ? JSON.parse(userComments) : [];

            // Add new comment
            const newComment = {
                id: Date.now(),
                comment: commentText,
                date: new Date().toISOString(),
                from: 'Coach'
            };

            comments.push(newComment);
            localStorage.setItem(`comments_${email}`, JSON.stringify(comments));

            // Clear form
            document.getElementById('motivationalComment').value = '';

            alert('Comment posted successfully!');
            
            // Refresh the view
            viewUserDetails(email);
        }

        function getMotivationalComments(email) {
            const userComments = localStorage.getItem(`comments_${email}`);
            const comments = userComments ? JSON.parse(userComments) : [];

            if (comments.length === 0) {
                return '<p style="color: #999; text-align: center;">No comments yet</p>';
            }

            return comments.map(comment => `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <strong style="color: #FF6B35;">Coach</strong>
                    <small style="color: #666; float: right;">${new Date(comment.date).toLocaleString()}</small>
                    <p style="margin-top: 10px; color: #333;">${comment.comment}</p>
                </div>
            `).join('');
        }

        // Progress Photo Functions
        function loadProgressPhotos() {
            const savedPhotos = localStorage.getItem(`photos_${currentUser.email}`);
            if (savedPhotos) {
                progressPhotos = JSON.parse(savedPhotos);
            } else {
                progressPhotos = [];
            }
            renderPhotos();
            updatePhotoStats();
        }

        function setupPhotoUpload() {
            const uploadArea = document.getElementById('uploadArea');
            
            // If upload area doesn't exist (not on photos tab), skip
            if (!uploadArea) {
                console.log('Upload area not found - user not on photos tab');
                return;
            }
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = '#e3e8ff';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = '';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = '';
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handlePhotoFile(files[0]);
                }
            });
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handlePhotoFile(file);
            }
        }

        function handlePhotoFile(file) {
            selectedPhotoFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.innerHTML = `
                    <img src="${e.target.result}" style="max-width: 100%; max-height: 300px; border-radius: 10px;">
                    <p style="margin-top: 10px;">Photo selected! Add details and save.</p>
                `;
            };
            reader.readAsDataURL(file);
        }

        function saveProgressPhoto() {
            if (!selectedPhotoFile) {
                alert('Please select a photo first');
                return;
            }

            const weight = document.getElementById('photoWeight').value;
            if (!weight) {
                alert('Please enter your current weight');
                return;
            }

            const notes = document.getElementById('photoNotes').value;

            const reader = new FileReader();
            reader.onload = function(e) {
                const photo = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    weight: parseFloat(weight),
                    notes: notes,
                    imageData: e.target.result
                };

                progressPhotos.push(photo);
                progressPhotos.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                localStorage.setItem(`photos_${currentUser.email}`, JSON.stringify(progressPhotos));

                // Reset form
                selectedPhotoFile = null;
                document.getElementById('photoWeight').value = '';
                document.getElementById('photoNotes').value = '';
                document.getElementById('uploadArea').innerHTML = `
                    <h3>üì∏ Click or Drag to Upload</h3>
                    <p>Take a new photo or select from gallery</p>
                `;
                document.getElementById('photoInput').value = '';

                renderPhotos();
                updatePhotoStats();
                alert('Progress photo saved successfully!');
            };
            reader.readAsDataURL(selectedPhotoFile);
        }

        function renderPhotos() {
            renderAllPhotos();
            renderRecentPhotos();
            renderTimeline();
            updateComparisonSelects();
        }

        function renderAllPhotos() {
            const container = document.getElementById('allPhotos');
            if (progressPhotos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No photos yet. Upload your first progress photo!</p>';
                return;
            }

            container.innerHTML = progressPhotos.map(photo => `
                <div class="photo-card" onclick="openPhotoModal('${photo.imageData}')">
                    <button class="delete-photo" onclick="event.stopPropagation(); deletePhoto(${photo.id})">√ó</button>
                    <img src="${photo.imageData}" alt="Progress photo">
                    <div class="photo-info">
                        <div class="photo-date">${new Date(photo.date).toLocaleDateString()}</div>
                        <div class="photo-weight">${photo.weight} lbs</div>
                    </div>
                </div>
            `).join('');
        }

        function renderRecentPhotos() {
            const container = document.getElementById('recentPhotos');
            const recent = progressPhotos.slice(-4);
            
            if (recent.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No photos yet</p>';
                return;
            }

            container.innerHTML = recent.map(photo => `
                <div class="photo-card" onclick="openPhotoModal('${photo.imageData}')">
                    <img src="${photo.imageData}" alt="Progress photo">
                    <div class="photo-info">
                        <div class="photo-date">${new Date(photo.date).toLocaleDateString()}</div>
                        <div class="photo-weight">${photo.weight} lbs</div>
                    </div>
                </div>
            `).join('');
        }

        function renderTimeline() {
            const container = document.getElementById('photoTimeline');
            if (progressPhotos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No timeline data yet</p>';
                return;
            }

            container.innerHTML = progressPhotos.map((photo, index) => {
                const weightChange = index > 0 ? 
                    (photo.weight - progressPhotos[index - 1].weight).toFixed(1) : 0;
                const changeText = weightChange > 0 ? `+${weightChange} lbs` : 
                                  weightChange < 0 ? `${weightChange} lbs` : 'Starting point';
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-marker">${index + 1}</div>
                        <div class="timeline-content">
                            <strong>${new Date(photo.date).toLocaleDateString()}</strong>
                            <div>Weight: ${photo.weight} lbs ${index > 0 ? `(${changeText})` : ''}</div>
                            ${photo.notes ? `<div style="margin-top: 5px; color: #666;">${photo.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateComparisonSelects() {
            const beforeSelect = document.getElementById('beforePhoto');
            const afterSelect = document.getElementById('afterPhoto');

            const options = progressPhotos.map((photo, index) => 
                `<option value="${index}">${new Date(photo.date).toLocaleDateString()} - ${photo.weight} lbs</option>`
            ).join('');

            beforeSelect.innerHTML = '<option value="">Select a photo...</option>' + options;

        // Tab Switching
        function switchDashTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            // Setup photo upload if switching to photos tab
            if (tabName === 'photos') {
                setTimeout(() => setupPhotoUpload(), 100);
            }
        }

        // Initialize
        window.onload = function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.isAdmin) {
                    loadAdminDashboard();
                    showPage('dashboard');
                } else if (currentUser.onboardingComplete) {
                    loadDashboard();
                    showPage('dashboard');
                } else {
                    startOnboarding();
                    showPage('onboarding');
                }
            }
            
            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
        };
    </script>
</body>
</html>
        // Onboarding Functions
        function startOnboarding() {
            currentStep = 1;
            updateProgress();
            renderOnboardingStep();
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function renderOnboardingStep() {
            const card = document.getElementById('onboardingCard');
            
            if (currentStep === 1) {
                // Step 1: Basic Info
                card.innerHTML = `
                    <h2>Welcome! Let's start with the basics</h2>
                    <p class="step-subtitle">This helps us understand where you're starting from</p>
                    
                    <div class="form-group">
                        <label>What's your name?</label>
                        <input type="text" id="userName" placeholder="Enter your first name" value="${userData.name || ''}">
                    </div>

                    <div class="two-column">
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" id="userAge" placeholder="Years" value="${userData.age || ''}">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="userGender">
                                <option value="">Select...</option>
                                <option value="male" ${userData.gender === 'male' ? 'selected' : ''}>Male</option>
                                <option value="female" ${userData.gender === 'female' ? 'selected' : ''}>Female</option>
                                <option value="other" ${userData.gender === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="two-column">
                        <div class="form-group">
                            <label>Height (feet)</label>
                            <input type="number" id="heightFeet" placeholder="5" value="${userData.heightFeet || ''}">
                        </div>
                        <div class="form-group">
                            <label>Height (inches)</label>
                            <input type="number" id="heightInches" placeholder="10" value="${userData.heightInches || ''}">
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                `;
            } else if (currentStep === 2) {
                // Step 2: Current Fitness
                card.innerHTML = `
                    <h2>Tell us about your current fitness</h2>
                    <p class="step-subtitle">Be honest - this helps us create a safe and effective plan</p>

                    <div class="form-group">
                        <label>Current Weight (lbs)</label>
                        <input type="number" id="currentWeight" step="0.1" placeholder="Enter your current weight" value="${userData.currentWeight || ''}">
                    </div>

                    <div class="form-group">
                        <label>What's your current activity level?</label>
                        <div class="options-grid">
                            <div class="option-card ${userData.activityLevel === 'sedentary' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'sedentary', this)">
                                <div class="emoji">üõãÔ∏è</div>
                                <div class="label">Sedentary</div>
                                <small>Little to no exercise</small>
                            </div>
                            <div class="option-card ${userData.activityLevel === 'light' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'light', this)">
                                <div class="emoji">üö∂</div>
                                <div class="label">Lightly Active</div>
                                <small>1-3 days/week</small>
                            </div>
                            <div class="option-card ${userData.activityLevel === 'moderate' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'moderate', this)">
                                <div class="emoji">üèÉ</div>
                                <div class="label">Moderately Active</div>
                                <small>3-5 days/week</small>
                            </div>
                            <div class="option-card ${userData.activityLevel === 'very' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'very', this)">
                                <div class="emoji">üí™</div>
                                <div class="label">Very Active</div>
                                <small>6-7 days/week</small>
                            </div>
                            <div class="option-card ${userData.activityLevel === 'extreme' ? 'selected' : ''}" onclick="selectOption('activityLevel', 'extreme', this)">
                                <div class="emoji">üèãÔ∏è</div>
                                <div class="label">Extremely Active</div>
                                <small>Athlete/physical job</small>
                            </div>
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
            } else if (currentStep === 3) {
                // Step 3: Goals
                card.innerHTML = `
                    <h2>What are your goals?</h2>
                    <p class="step-subtitle">Select all that apply - we'll create a plan that addresses everything</p>

                    <div class="form-group">
                        <label>Primary Goals (select all that apply)</label>
                        <div class="checkbox-group">
                            ${createCheckbox('goals', 'weight-loss', 'üéØ Weight Loss', userData.goals)}
                            ${createCheckbox('goals', 'muscle-gain', 'üí™ Build Muscle', userData.goals)}
                            ${createCheckbox('goals', 'strength', 'üèãÔ∏è Increase Strength', userData.goals)}
                            ${createCheckbox('goals', 'endurance', 'üèÉ Improve Endurance', userData.goals)}
                            ${createCheckbox('goals', 'tone', '‚ú® Tone & Definition', userData.goals)}
                            ${createCheckbox('goals', 'health', '‚ù§Ô∏è General Health', userData.goals)}
                        </div>
                    </div>

                    <div class="two-column">
                        <div class="form-group">
                            <label>Goal Weight (lbs)</label>
                            <input type="number" id="goalWeight" step="0.1" value="${userData.goalWeight || ''}">
                        </div>
                        <div class="form-group">
                            <label>Timeline</label>
                            <select id="timeline">
                                <option value="">Select...</option>
                                <option value="3months" ${userData.timeline === '3months' ? 'selected' : ''}>3 months</option>
                                <option value="6months" ${userData.timeline === '6months' ? 'selected' : ''}>6 months</option>
                                <option value="1year" ${userData.timeline === '1year' ? 'selected' : ''}>1 year</option>
                                <option value="ongoing" ${userData.timeline === 'ongoing' ? 'selected' : ''}>Ongoing journey</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
            } else if (currentStep === 4) {
                // Step 4: Workout Preferences
                card.innerHTML = `
                    <h2>Workout Preferences</h2>
                    <p class="step-subtitle">Help us design your perfect workout plan</p>

                    <div class="form-group">
                        <label>How many days per week can you work out?</label>
                        <div class="slider-container">
                            <input type="range" min="2" max="7" value="${userData.workoutDays || 4}" class="slider" id="workoutDays" oninput="updateSlider('workoutDays', 'workoutDaysValue', ' days/week')">
                            <div class="slider-value" id="workoutDaysValue">${userData.workoutDays || 4} days/week</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Workout Duration</label>
                        <select id="workoutDuration">
                            <option value="">Select...</option>
                            <option value="30" ${userData.workoutDuration === '30' ? 'selected' : ''}>30 minutes</option>
                            <option value="45" ${userData.workoutDuration === '45' ? 'selected' : ''}>45 minutes</option>
                            <option value="60" ${userData.workoutDuration === '60' ? 'selected' : ''}>60 minutes</option>
                            <option value="90" ${userData.workoutDuration === '90' ? 'selected' : ''}>90+ minutes</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Where will you work out? (select all)</label>
                        <div class="checkbox-group">
                            ${createCheckbox('locations', 'home', 'üè† Home', userData.locations)}
                            ${createCheckbox('locations', 'gym', 'üèãÔ∏è Gym', userData.locations)}
                            ${createCheckbox('locations', 'outdoors', 'üå≥ Outdoors', userData.locations)}
                            ${createCheckbox('locations', 'studio', 'üéØ Studio/Class', userData.locations)}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Available Equipment (select all)</label>
                        <div class="checkbox-group">
                            ${createCheckbox('equipment', 'none', 'üö´ None (Bodyweight)', userData.equipment)}
                            ${createCheckbox('equipment', 'dumbbells', 'üèãÔ∏è Dumbbells', userData.equipment)}
                            ${createCheckbox('equipment', 'barbell', 'üí™ Barbell', userData.equipment)}
                            ${createCheckbox('equipment', 'bands', 'üéÄ Resistance Bands', userData.equipment)}
                            ${createCheckbox('equipment', 'full-gym', 'üè¢ Full Gym', userData.equipment)}
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
                updateSlider('workoutDays', 'workoutDaysValue', ' days/week');
            } else if (currentStep === 5) {
                // Step 5: Nutrition
                card.innerHTML = `
                    <h2>Nutrition Preferences</h2>
                    <p class="step-subtitle">Let's personalize your meal plan</p>

                    <div class="form-group">
                        <label>Dietary Preferences (select all that apply)</label>
                        <div class="checkbox-group">
                            ${createCheckbox('diet', 'none', 'üçΩÔ∏è No Restrictions', userData.diet)}
                            ${createCheckbox('diet', 'vegetarian', 'ü•ó Vegetarian', userData.diet)}
                            ${createCheckbox('diet', 'vegan', 'üå± Vegan', userData.diet)}
                            ${createCheckbox('diet', 'keto', 'ü•ë Keto', userData.diet)}
                            ${createCheckbox('diet', 'paleo', 'üçñ Paleo', userData.diet)}
                            ${createCheckbox('diet', 'gluten-free', 'üåæ Gluten-Free', userData.diet)}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Food Allergies/Intolerances</label>
                        <input type="text" id="allergies" placeholder="e.g., nuts, dairy, shellfish" value="${userData.allergies || ''}">
                    </div>

                    <div class="form-group">
                        <label>How many meals per day?</label>
                        <div class="slider-container">
                            <input type="range" min="2" max="6" value="${userData.mealsPerDay || 3}" class="slider" id="mealsPerDay" oninput="updateSlider('mealsPerDay', 'mealsValue', ' meals')">
                            <div class="slider-value" id="mealsValue">${userData.mealsPerDay || 3} meals</div>
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
                updateSlider('mealsPerDay', 'mealsValue', ' meals');
            } else if (currentStep === 6) {
                // Step 6: Lifestyle
                card.innerHTML = `
                    <h2>Lifestyle & Schedule</h2>
                    <p class="step-subtitle">This helps us fit fitness into your life</p>

                    <div class="form-group">
                        <label>Work Schedule</label>
                        <select id="workSchedule">
                            <option value="">Select...</option>
                            <option value="9-5" ${userData.workSchedule === '9-5' ? 'selected' : ''}>9-5 (Mon-Fri)</option>
                            <option value="shift" ${userData.workSchedule === 'shift' ? 'selected' : ''}>Shift Work</option>
                            <option value="irregular" ${userData.workSchedule === 'irregular' ? 'selected' : ''}>Irregular</option>
                            <option value="flexible" ${userData.workSchedule === 'flexible' ? 'selected' : ''}>Flexible</option>
                            <option value="retired" ${userData.workSchedule === 'retired' ? 'selected' : ''}>Retired/Student</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Preferred Workout Times (select all)</label>
                        <div class="checkbox-group">
                            ${createCheckbox('workoutTimes', 'early-morning', 'üåÖ Early Morning (5-7am)', userData.workoutTimes)}
                            ${createCheckbox('workoutTimes', 'morning', '‚òÄÔ∏è Morning (7-10am)', userData.workoutTimes)}
                            ${createCheckbox('workoutTimes', 'midday', '‚òÄÔ∏è Midday (10am-2pm)', userData.workoutTimes)}
                            ${createCheckbox('workoutTimes', 'afternoon', 'üå§Ô∏è Afternoon (2-6pm)', userData.workoutTimes)}
                            ${createCheckbox('workoutTimes', 'evening', 'üåÜ Evening (6-9pm)', userData.workoutTimes)}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Average Sleep per Night</label>
                        <div class="slider-container">
                            <input type="range" min="4" max="10" value="${userData.sleepHours || 7}" class="slider" id="sleepHours" oninput="updateSlider('sleepHours', 'sleepValue', ' hours')">
                            <div class="slider-value" id="sleepValue">${userData.sleepHours || 7} hours</div>
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
                updateSlider('sleepHours', 'sleepValue', ' hours');
            } else if (currentStep === 7) {
                // Step 7: Motivation
                card.innerHTML = `
                    <h2>Your Motivation</h2>
                    <p class="step-subtitle">Understanding your "why" helps keep you accountable</p>

                    <div class="form-group">
                        <label>What's your primary motivation for this transformation?</label>
                        <textarea id="motivation" rows="4" placeholder="Be specific... What will achieving your goals mean for you?">${userData.motivation || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>What has stopped you from reaching your goals before?</label>
                        <textarea id="pastBarriers" rows="3" placeholder="Time, motivation, injuries, not knowing what to do...">${userData.pastBarriers || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>How do you prefer to learn?</label>
                        <select id="learningStyle">
                            <option value="">Select...</option>
                            <option value="video" ${userData.learningStyle === 'video' ? 'selected' : ''}>Video Demonstrations</option>
                            <option value="written" ${userData.learningStyle === 'written' ? 'selected' : ''}>Written Instructions</option>
                            <option value="both" ${userData.learningStyle === 'both' ? 'selected' : ''}>Both Video & Written</option>
                        </select>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
            } else if (currentStep === 8) {
                // Step 8: Medical & Final
                card.innerHTML = `
                    <h2>Medical Information</h2>
                    <p class="step-subtitle">Helps us keep you safe and injury-free</p>

                    <div class="form-group">
                        <label>Do you have any injuries or physical limitations?</label>
                        <textarea id="injuries" rows="3" placeholder="e.g., bad knee, lower back pain, shoulder issues...">${userData.injuries || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Any medical conditions we should know about?</label>
                        <textarea id="medicalConditions" rows="3" placeholder="e.g., diabetes, heart condition, asthma...">${userData.medicalConditions || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Have you worked with a coach before?</label>
                        <select id="previousCoaching">
                            <option value="no" ${userData.previousCoaching === 'no' ? 'selected' : ''}>No, first time</option>
                            <option value="yes-online" ${userData.previousCoaching === 'yes-online' ? 'selected' : ''}>Yes, online coaching</option>
                            <option value="yes-person" ${userData.previousCoaching === 'yes-person' ? 'selected' : ''}>Yes, in-person coaching</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Anything else you'd like us to know?</label>
                        <textarea id="additionalNotes" rows="3" placeholder="Any other information that might help us support you better...">${userData.additionalNotes || ''}</textarea>
                    </div>

                    <button class="btn" onclick="completeOnboarding()">Complete Setup üéâ</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
            }
        }

        function createCheckbox(groupName, value, label, selectedArray) {
            const isSelected = selectedArray && selectedArray.includes(value);
            return `
                <div class="checkbox-item ${isSelected ? 'selected' : ''}" onclick="toggleCheckbox('${groupName}', '${value}', this)">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation();">
                    <span>${label}</span>
                </div>
            `;
        }

        function toggleCheckbox(groupName, value, element) {
            if (!userData[groupName]) userData[groupName] = [];
            const index = userData[groupName].indexOf(value);
            if (index > -1) {
                userData[groupName].splice(index, 1);
                element.classList.remove('selected');
                element.querySelector('input').checked = false;
            } else {
                userData[groupName].push(value);
                element.classList.add('selected');
                element.querySelector('input').checked = true;
            }
        }

        function selectOption(fieldName, value, element) {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            userData[fieldName] = value;
        }

        function updateSlider(sliderId, valueId, suffix) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            if (slider && valueDisplay) {
                valueDisplay.textContent = slider.value + suffix;
            }
        }
        function nextOnboardingStep() {
            // Save current step data
            if (currentStep === 1) {
                userData.name = document.getElementById('userName').value;
                userData.age = document.getElementById('userAge').value;
                userData.gender = document.getElementById('userGender').value;
                userData.heightFeet = document.getElementById('heightFeet').value;
                userData.heightInches = document.getElementById('heightInches').value;

                if (!userData.name || !userData.age || !userData.gender || !userData.heightFeet || !userData.heightInches) {
                    alert('Please fill in all fields');
                    return;
                }
            } else if (currentStep === 2) {
                userData.currentWeight = document.getElementById('currentWeight').value;
                if (!userData.currentWeight || !userData.activityLevel) {
                    alert('Please fill in all fields');
                    return;
                }
            } else if (currentStep === 3) {
                userData.goalWeight = document.getElementById('goalWeight').value;
                userData.timeline = document.getElementById('timeline').value;
                if (!userData.goalWeight || !userData.goals || userData.goals.length === 0) {
                    alert('Please enter goal weight and select at least one goal');
                    return;
                }
            } else if (currentStep === 4) {
                userData.workoutDays = document.getElementById('workoutDays').value;
                userData.workoutDuration = document.getElementById('workoutDuration').value;
                if (!userData.workoutDuration || !userData.locations || userData.locations.length === 0) {
                    alert('Please complete all fields and select workout locations');
                    return;
                }
            } else if (currentStep === 5) {
                userData.allergies = document.getElementById('allergies').value;
                userData.mealsPerDay = document.getElementById('mealsPerDay').value;
                if (!userData.diet || userData.diet.length === 0) {
                    alert('Please select at least one dietary preference');
                    return;
                }
            } else if (currentStep === 6) {
                userData.workSchedule = document.getElementById('workSchedule').value;
                userData.sleepHours = document.getElementById('sleepHours').value;
                if (!userData.workSchedule || !userData.workoutTimes || userData.workoutTimes.length === 0) {
                    alert('Please complete all fields');
                    return;
                }
            } else if (currentStep === 7) {
                userData.motivation = document.getElementById('motivation').value;
                userData.pastBarriers = document.getElementById('pastBarriers').value;
                userData.learningStyle = document.getElementById('learningStyle').value;
                if (!userData.motivation || !userData.learningStyle) {
                    alert('Please share your motivation and select a learning style');
                    return;
                }
            }

            currentStep++;
            updateProgress();
            renderOnboardingStep();
        }

        function prevOnboardingStep() {
            currentStep--;
            updateProgress();
            renderOnboardingStep();
        }

        function completeOnboarding() {
            console.log('Complete onboarding called');
            
            // Save Step 8 data
            userData.injuries = document.getElementById('injuries').value;
            userData.medicalConditions = document.getElementById('medicalConditions').value;
            userData.previousCoaching = document.getElementById('previousCoaching').value;
            userData.additionalNotes = document.getElementById('additionalNotes').value;

            // Calculate BMR and TDEE
            const heightInInches = parseInt(userData.heightFeet) * 12 + parseInt(userData.heightInches);
            const weightInKg = parseFloat(userData.currentWeight) * 0.453592;
            const heightInCm = heightInInches * 2.54;
            const age = parseInt(userData.age);

            // Mifflin-St Jeor Equation
            let bmr;
            if (userData.gender === 'male') {
                bmr = (10 * weightInKg) + (6.25 * heightInCm) - (5 * age) + 5;
            } else {
                bmr = (10 * weightInKg) + (6.25 * heightInCm) - (5 * age) - 161;
            }

            // Activity multipliers
            const activityMultipliers = {
                'sedentary': 1.2,
                'light': 1.375,
                'moderate': 1.55,
                'very': 1.725,
                'extreme': 1.9
            };

            const tdee = Math.round(bmr * (activityMultipliers[userData.activityLevel] || 1.2));
            
            // Calorie targets based on goals
            const weightDiff = parseFloat(userData.currentWeight) - parseFloat(userData.goalWeight);
            let calorieTarget;
            if (weightDiff > 0) {
                // Weight loss
                calorieTarget = tdee - 500;
            } else if (weightDiff < 0) {
                // Weight gain
                calorieTarget = tdee + 300;
            } else {
                // Maintenance
                calorieTarget = tdee;
            }

            userData.bmr = Math.round(bmr);
            userData.tdee = tdee;
            userData.calorieTarget = calorieTarget;
            userData.onboardingComplete = true;

            // Update user
            currentUser = { ...currentUser, ...userData };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            users[currentUser.email] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));

            console.log('Loading dashboard...');
            
            try {
                loadDashboard();
                showPage('dashboard');
                console.log('Dashboard loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        // Onboarding Functions
        function startOnboarding() {
            currentStep = 1;
            updateProgress();
            renderOnboardingStep();
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function selectOption(key, value, element) {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            userData[key] = value;
        }

        function toggleCheckbox(key, value, element) {
            if (!userData[key]) userData[key] = [];
            const index = userData[key].indexOf(value);
            if (index > -1) {
                userData[key].splice(index, 1);
                element.classList.remove('selected');
            } else {
                userData[key].push(value);
                element.classList.add('selected');
            }
        }

        function updateSlider(sliderId, valueId, suffix) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            if (slider && valueDisplay) {
                valueDisplay.textContent = slider.value + suffix;
            }
        }
        function renderOnboardingStep() {
            const card = document.getElementById('onboardingCard');
            
            if (currentStep === 1) {
                card.innerHTML = `
                    <div class="step">
                        <h2>Welcome! Let's start with the basics</h2>
                        <p class="step-subtitle">This helps us understand where you're starting from</p>
                        
                        <div class="form-group">
                            <label>What's your name?</label>
                            <input type="text" id="userName" placeholder="Enter your first name" value="${userData.name || ''}">
                        </div>

                        <div class="two-column">
                            <div class="form-group">
                                <label>Age</label>
                                <input type="number" id="userAge" placeholder="Years" value="${userData.age || ''}">
                            </div>
                            <div class="form-group">
                                <label>Gender</label>
                                <select id="userGender">
                                    <option value="">Select...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="two-column">
                            <div class="form-group">
                                <label>Height (feet)</label>
                                <input type="number" id="heightFeet" placeholder="5" value="${userData.heightFeet || ''}">
                            </div>
                            <div class="form-group">
                                <label>Height (inches)</label>
                                <input type="number" id="heightInches" placeholder="10" value="${userData.heightInches || ''}">
                            </div>
                        </div>

                        <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    </div>
                `;
            } else if (currentStep === 2) {
                card.innerHTML = `
                    <div class="step">
                        <h2>Current Fitness Level</h2>
                        <p class="step-subtitle">Be honest - this helps us create a safe plan</p>

                        <div class="form-group">
                            <label>Current Weight (lbs)</label>
                            <input type="number" id="currentWeight" step="0.1" placeholder="Enter weight" value="${userData.currentWeight || ''}">
                        </div>

                        <div class="form-group">
                            <label>Activity Level</label>
                            <div class="options-grid">
                                <div class="option-card" onclick="selectOption('activityLevel', 'sedentary', this)">
                                    <div class="emoji">üõãÔ∏è</div>
                                    <div class="label">Sedentary</div>
                                </div>
                                <div class="option-card" onclick="selectOption('activityLevel', 'light', this)">
                                    <div class="emoji">üö∂</div>
                                    <div class="label">Light</div>
                                </div>
                                <div class="option-card" onclick="selectOption('activityLevel', 'moderate', this)">
                                    <div class="emoji">üèÉ</div>
                                    <div class="label">Moderate</div>
                                </div>
                                <div class="option-card" onclick="selectOption('activityLevel', 'very', this)">
                                    <div class="emoji">üí™</div>
                                    <div class="label">Very Active</div>
                                </div>
                            </div>
                        </div>

                        <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                        <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                    </div>
                `;
            } else if (currentStep === 3) {
                card.innerHTML = `
                    <div class="step">
                        <h2>Your Goals</h2>
                        <p class="step-subtitle">Select all that apply</p>

                        <div class="form-group">
                            <label>Primary Goals</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item" onclick="toggleCheckbox('goals', 'weight-loss', this)">
                                    <input type="checkbox"><span>üéØ Weight Loss</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('goals', 'muscle-gain', this)">
                                    <input type="checkbox"><span>üí™ Build Muscle</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('goals', 'strength', this)">
                                    <input type="checkbox"><span>üèãÔ∏è Get Stronger</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('goals', 'endurance', this)">
                                    <input type="checkbox"><span>üèÉ Endurance</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('goals', 'tone', this)">
                                    <input type="checkbox"><span>‚ú® Tone Up</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('goals', 'health', this)">
                                    <input type="checkbox"><span>‚ù§Ô∏è Health</span>
                                </div>
                            </div>
                        </div>

                        <div class="two-column">
                            <div class="form-group">
                                <label>Goal Weight (lbs)</label>
                                <input type="number" id="goalWeight" step="0.1" value="${userData.goalWeight || ''}">
                            </div>
                            <div class="form-group">
                                <label>Timeline</label>
                                <select id="timeline">
                                    <option value="">Select...</option>
                                    <option value="3months">3 months</option>
                                    <option value="6months">6 months</option>
                                    <option value="1year">1 year</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                        <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                    </div>
                `;
            } else if (currentStep === 4) {
                card.innerHTML = `
                    <div class="step">
                        <h2>Workout Preferences</h2>
                        <p class="step-subtitle">Help us design your perfect routine</p>

                        <div class="form-group">
                            <label>Days per week?</label>
                            <input type="range" min="2" max="7" value="${userData.workoutDays || 4}" class="slider" id="workoutDays" oninput="updateSlider('workoutDays', 'workoutDaysValue', ' days/week')">
                            <div class="slider-value" id="workoutDaysValue">${userData.workoutDays || 4} days/week</div>
                        </div>

                        <div class="form-group">
                            <label>Workout Duration</label>
                            <select id="workoutDuration">
                                <option value="">Select...</option>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">60 minutes</option>
                                <option value="90">90+ minutes</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Where? (select all)</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item" onclick="toggleCheckbox('locations', 'home', this)">
                                    <input type="checkbox"><span>üè† Home</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('locations', 'gym', this)">
                                    <input type="checkbox"><span>üèãÔ∏è Gym</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('locations', 'outdoors', this)">
                                    <input type="checkbox"><span>üå≥ Outdoors</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Equipment (select all)</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item" onclick="toggleCheckbox('equipment', 'none', this)">
                                    <input type="checkbox"><span>üö´ None</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('equipment', 'dumbbells', this)">
                                    <input type="checkbox"><span>üèãÔ∏è Dumbbells</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('equipment', 'barbell', this)">
                                    <input type="checkbox"><span>üí™ Barbell</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('equipment', 'bands', this)">
                                    <input type="checkbox"><span>üéÄ Bands</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('equipment', 'full-gym', this)">
                                    <input type="checkbox"><span>üè¢ Full Gym</span>
                                </div>
                            </div>
                        </div>

                        <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                        <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                    </div>
                `;
                updateSlider('workoutDays', 'workoutDaysValue', ' days/week');
            } else if (currentStep === 5) {
                card.innerHTML = `
                    <div class="step">
                        <h2>Nutrition</h2>
                        <p class="step-subtitle">Let's personalize your meal plan</p>

                        <div class="form-group">
                            <label>Diet Type (select all)</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item" onclick="toggleCheckbox('diet', 'none', this)">
                                    <input type="checkbox"><span>üçΩÔ∏è No Restrictions</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('diet', 'vegetarian', this)">
                                    <input type="checkbox"><span>ü•ó Vegetarian</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('diet', 'vegan', this)">
                                    <input type="checkbox"><span>üå± Vegan</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('diet', 'keto', this)">
                                    <input type="checkbox"><span>ü•ë Keto</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Allergies</label>
                            <input type="text" id="allergies" placeholder="e.g., nuts, dairy" value="${userData.allergies || ''}">
                        </div>

                        <div class="form-group">
                            <label>Meals per day?</label>
                            <input type="range" min="2" max="6" value="${userData.mealsPerDay || 3}" class="slider" id="mealsPerDay" oninput="updateSlider('mealsPerDay', 'mealsValue', ' meals')">
                            <div class="slider-value" id="mealsValue">${userData.mealsPerDay || 3} meals</div>
                        </div>

                        <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                        <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                    </div>
                `;
                updateSlider('mealsPerDay', 'mealsValue', ' meals');
            } else if (currentStep === 6) {
                card.innerHTML = `
                    <div class="step">
                        <h2>Lifestyle</h2>
                        <p class="step-subtitle">Help us fit fitness into your life</p>

                        <div class="form-group">
                            <label>Work Schedule</label>
                            <select id="workSchedule">
                                <option value="">Select...</option>
                                <option value="9-5">9-5 (Mon-Fri)</option>
                                <option value="shift">Shift Work</option>
                                <option value="irregular">Irregular</option>
                                <option value="flexible">Flexible</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Workout Times (select all)</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item" onclick="toggleCheckbox('workoutTimes', 'morning', this)">
                                    <input type="checkbox"><span>üåÖ Morning</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('workoutTimes', 'afternoon', this)">
                                    <input type="checkbox"><span>‚òÄÔ∏è Afternoon</span>
                                </div>
                                <div class="checkbox-item" onclick="toggleCheckbox('workoutTimes', 'evening', this)">
                                    <input type="checkbox"><span>üåÜ Evening</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Sleep per night?</label>
                            <input type="range" min="4" max="10" value="${userData.sleepHours || 7}" class="slider" id="sleepHours" oninput="updateSlider('sleepHours', 'sleepValue', ' hours')">
                            <div class="slider-value" id="sleepValue">${userData.sleepHours || 7} hours</div>
                        </div>

                        <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                        <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                    </div>
                `;
                updateSlider('sleepHours', 'sleepValue', ' hours');
            } else if (currentStep === 7) {
                card.innerHTML = `
                    <div class="step">
                        <h2>Your Motivation</h2>
                        <p class="step-subtitle">Understanding your "why" keeps you accountable</p>

                        <div class="form-group">
                            <label>What's your primary motivation?</label>
                            <textarea id="motivation" rows="4" placeholder="Be specific... What does achieving your goals mean for you?">${userData.motivation || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>What stopped you before?</label>
                            <textarea id="pastBarriers" rows="3" placeholder="Time, motivation, injuries...">${userData.pastBarriers || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Learning style?</label>
                            <select id="learningStyle">
                                <option value="">Select...</option>
                                <option value="video">Video</option>
                                <option value="written">Written</option>
                                <option value="both">Both</option>
                            </select>
                        </div>

                        <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                        <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                    </div>
                `;
            } else if (currentStep === 8) {
                card.innerHTML = `
                    <div class="step">
                        <h2>Medical & Final</h2>
                        <p class="step-subtitle">Keeps you safe and injury-free</p>

                        <div class="form-group">
                            <label>Injuries or limitations?</label>
                            <textarea id="injuries" rows="3" placeholder="e.g., bad knee, back pain...">${userData.injuries || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Medical conditions?</label>
                            <textarea id="medicalConditions" rows="3" placeholder="e.g., diabetes, asthma...">${userData.medicalConditions || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Previous coaching?</label>
                            <select id="previousCoaching">
                                <option value="no">No, first time</option>
                                <option value="yes-online">Yes, online</option>
                                <option value="yes-person">Yes, in-person</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Anything else?</label>
                            <textarea id="additionalNotes" rows="3" placeholder="Any other information...">${userData.additionalNotes || ''}</textarea>
                        </div>

                        <button class="btn" onclick="completeOnboarding()">Complete Setup üéâ</button>
                        <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                    </div>
                `;
            }
        }
        function nextOnboardingStep() {
            // Validate and save current step
            if (currentStep === 1) {
                userData.name = document.getElementById('userName').value;
                userData.age = document.getElementById('userAge').value;
                userData.gender = document.getElementById('userGender').value;
                userData.heightFeet = document.getElementById('heightFeet').value;
                userData.heightInches = document.getElementById('heightInches').value;
                if (!userData.name || !userData.age || !userData.gender) {
                    alert('Please fill in all fields');
                    return;
                }
            } else if (currentStep === 2) {
                userData.currentWeight = document.getElementById('currentWeight').value;
                if (!userData.currentWeight || !userData.activityLevel) {
                    alert('Please fill in all fields');
                    return;
                }
            } else if (currentStep === 3) {
                userData.goalWeight = document.getElementById('goalWeight').value;
                userData.timeline = document.getElementById('timeline').value;
                if (!userData.goalWeight || !userData.goals || userData.goals.length === 0) {
                    alert('Please enter goal weight and select goals');
                    return;
                }
            } else if (currentStep === 4) {
                userData.workoutDays = document.getElementById('workoutDays').value;
                userData.workoutDuration = document.getElementById('workoutDuration').value;
                if (!userData.workoutDuration) {
                    alert('Please complete all fields');
                    return;
                }
            } else if (currentStep === 5) {
                userData.allergies = document.getElementById('allergies').value;
                userData.mealsPerDay = document.getElementById('mealsPerDay').value;
            } else if (currentStep === 6) {
                userData.workSchedule = document.getElementById('workSchedule').value;
                userData.sleepHours = document.getElementById('sleepHours').value;
            } else if (currentStep === 7) {
                userData.motivation = document.getElementById('motivation').value;
                userData.pastBarriers = document.getElementById('pastBarriers').value;
                userData.learningStyle = document.getElementById('learningStyle').value;
                if (!userData.motivation) {
                    alert('Please share your motivation');
                    return;
                }
            }

            currentStep++;
            updateProgress();
            renderOnboardingStep();
        }

        function prevOnboardingStep() {
            currentStep--;
            updateProgress();
            renderOnboardingStep();
        }

        function completeOnboarding() {
            // Save final step
            userData.injuries = document.getElementById('injuries').value;
            userData.medicalConditions = document.getElementById('medicalConditions').value;
            userData.previousCoaching = document.getElementById('previousCoaching').value;
            userData.additionalNotes = document.getElementById('additionalNotes').value;

            // Calculate BMR and TDEE
            const heightInInches = parseInt(userData.heightFeet || 0) * 12 + parseInt(userData.heightInches || 0);
            const weightInKg = parseFloat(userData.currentWeight) * 0.453592;
            const heightInCm = heightInInches * 2.54;
            const age = parseInt(userData.age);

            let bmr;
            if (userData.gender === 'male') {
                bmr = (10 * weightInKg) + (6.25 * heightInCm) - (5 * age) + 5;
            } else {
                bmr = (10 * weightInKg) + (6.25 * heightInCm) - (5 * age) - 161;
            }

            const activityMultipliers = {
                'sedentary': 1.2,
                'light': 1.375,
                'moderate': 1.55,
                'very': 1.725,
                'extreme': 1.9
            };

            const tdee = Math.round(bmr * (activityMultipliers[userData.activityLevel] || 1.2));
            
            const weightDiff = parseFloat(userData.currentWeight) - parseFloat(userData.goalWeight);
            let calorieTarget;
            if (weightDiff > 0) {
                calorieTarget = tdee - 500;
            } else if (weightDiff < 0) {
                calorieTarget = tdee + 300;
            } else {
                calorieTarget = tdee;
            }

            userData.bmr = Math.round(bmr);
            userData.tdee = tdee;
            userData.calorieTarget = calorieTarget;
            userData.onboardingComplete = true;

            currentUser = { ...currentUser, ...userData };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            users[currentUser.email] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));

            loadDashboard();
            showPage('dashboard');
        }

        // Dashboard Functions
        function switchDashTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'photos') {
                loadProgressPhotos();
            }
        }

        function loadDashboard() {
            try {
                // Set dashboard values
                const nameEl = document.getElementById('dashboardName');
                if (nameEl) nameEl.textContent = currentUser.name || 'User';
                
                const currentWeightEl = document.getElementById('dashCurrentWeight');
                if (currentWeightEl) currentWeightEl.textContent = currentUser.currentWeight || '--';
                
                const goalWeightEl = document.getElementById('dashGoalWeight');
                if (goalWeightEl) goalWeightEl.textContent = currentUser.goalWeight || '--';
                
                const caloriesEl = document.getElementById('dashCalories');
                if (caloriesEl) caloriesEl.textContent = currentUser.calorieTarget || '--';
                
                const workoutsEl = document.getElementById('dashWorkouts');
                if (workoutsEl) workoutsEl.textContent = currentUser.workoutDays || '--';
                
                const emailEl = document.getElementById('userEmail');
                if (emailEl) emailEl.textContent = currentUser.email || '';

                const tdeeEl = document.getElementById('dashTDEE');
                if (tdeeEl) tdeeEl.textContent = currentUser.tdee || '--';
                
                // Weight to go
                if (currentUser.currentWeight && currentUser.goalWeight) {
                    const weightToGo = Math.abs(currentUser.currentWeight - currentUser.goalWeight).toFixed(1);
                    const weightToGoEl = document.getElementById('dashWeightToGo');
                    if (weightToGoEl) weightToGoEl.textContent = weightToGo;
                }

                // Display goals
                const goalsEl = document.getElementById('userGoals');
                if (goalsEl && currentUser.goals) {
                    goalsEl.innerHTML = currentUser.goals.map(g => 
                        `<div>‚Ä¢ ${g.replace('-', ' ').toUpperCase()}</div>`
                    ).join('');
                }
                
                // Load photos count
                loadProgressPhotos();
                
                // Load messages if any
                try {
                    loadUserMessages();
                } catch (e) {
                    console.log('No messages:', e);
                }
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }

        function loadUserMessages() {
            const messages = JSON.parse(localStorage.getItem(`messages_${currentUser.email}`) || '[]');
            const comments = JSON.parse(localStorage.getItem(`comments_${currentUser.email}`) || '[]');

            if (messages.length > 0) {
                document.getElementById('coachMessages').style.display = 'block';
                const messagesList = document.getElementById('userMessagesList');
                messagesList.innerHTML = messages.slice(-5).reverse().map(msg => `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #FF6B35;">
                        <strong style="color: #FF6B35;">${msg.type.toUpperCase()}</strong>
                        <p style="margin: 10px 0;">${msg.message}</p>
                        <small style="color: #999;">${new Date(msg.timestamp).toLocaleDateString()}</small>
                    </div>
                `).join('');
            }

            if (comments.length > 0) {
                document.getElementById('coachComments').style.display = 'block';
                const commentsList = document.getElementById('userCommentsList');
                commentsList.innerHTML = comments.slice(-5).reverse().map(comment => `
                    <div style="background: #ffe8df; padding: 15px; border-radius: 10px; margin: 10px 0;">
                        <p style="margin: 0;">${comment.comment}</p>
                        <small style="color: #999;">${new Date(comment.timestamp).toLocaleDateString()}</small>
                    </div>
                `).join('');
            }
        }
        // Progress Photos Functions
        function loadProgressPhotos() {
            const photos = JSON.parse(localStorage.getItem(`photos_${currentUser.email}`) || '[]');
            progressPhotos = photos;

            // Update photo count
            const photoCountEl = document.getElementById('dashTotalPhotos');
            if (photoCountEl) photoCountEl.textContent = photos.length;

            // Load recent photos
            const recentPhotosEl = document.getElementById('recentPhotos');
            if (recentPhotosEl) {
                const recentPhotos = photos.slice(-4).reverse();
                if (recentPhotos.length > 0) {
                    recentPhotosEl.innerHTML = recentPhotos.map(photo => `
                        <div class="photo-card" onclick="openPhotoModal('${photo.image}')">
                            <img src="${photo.image}" alt="Progress">
                            <div class="photo-info">
                                <div class="photo-date">${new Date(photo.date).toLocaleDateString()}</div>
                                <div class="photo-weight">${photo.weight} lbs</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    recentPhotosEl.innerHTML = '<p style="text-align: center; color: #999;">No photos yet. Upload your first progress photo!</p>';
                }
            }

            // Load all photos in photos tab
            const allPhotosEl = document.getElementById('allPhotos');
            if (allPhotosEl) {
                if (photos.length > 0) {
                    allPhotosEl.innerHTML = photos.slice().reverse().map((photo, index) => `
                        <div class="photo-card">
                            <img src="${photo.image}" alt="Progress" onclick="openPhotoModal('${photo.image}')">
                            <button class="delete-photo" onclick="deletePhoto(${photos.length - 1 - index})">√ó</button>
                            <div class="photo-info">
                                <div class="photo-date">${new Date(photo.date).toLocaleDateString()}</div>
                                <div class="photo-weight">${photo.weight} lbs</div>
                                ${photo.notes ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">${photo.notes}</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    allPhotosEl.innerHTML = '<p style="text-align: center; color: #999;">No photos yet</p>';
                }
            }

            // Load timeline
            const timelineEl = document.getElementById('photoTimeline');
            if (timelineEl && photos.length > 0) {
                timelineEl.innerHTML = photos.slice().reverse().map((photo, index) => {
                    const prevPhoto = photos[photos.length - 2 - index];
                    let weightChange = '';
                    if (prevPhoto) {
                        const diff = (photo.weight - prevPhoto.weight).toFixed(1);
                        weightChange = diff > 0 ? `+${diff} lbs` : `${diff} lbs`;
                    }
                    return `
                        <div class="timeline-item">
                            <div class="timeline-marker">${photos.length - index}</div>
                            <div class="timeline-content">
                                <strong>${new Date(photo.date).toLocaleDateString()}</strong>
                                <div>Weight: ${photo.weight} lbs ${weightChange ? `<span style="color: ${diff < 0 ? '#28a745' : '#dc3545'}">(${weightChange})</span>` : ''}</div>
                                ${photo.notes ? `<div style="margin-top: 10px; font-style: italic;">"${photo.notes}"</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Update comparison dropdowns
            updateComparisonSelects();
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedPhotoFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedPhotoFile = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveProgressPhoto() {
            if (!selectedPhotoFile) {
                alert('Please select a photo first');
                return;
            }

            const weight = document.getElementById('photoWeight').value;
            if (!weight) {
                alert('Please enter your weight');
                return;
            }

            const notes = document.getElementById('photoNotes').value;

            const photo = {
                image: selectedPhotoFile,
                weight: parseFloat(weight),
                notes: notes,
                date: new Date().toISOString()
            };

            const photos = JSON.parse(localStorage.getItem(`photos_${currentUser.email}`) || '[]');
            photos.push(photo);
            localStorage.setItem(`photos_${currentUser.email}`, JSON.stringify(photos));

            // Clear form
            document.getElementById('photoInput').value = '';
            document.getElementById('photoWeight').value = '';
            document.getElementById('photoNotes').value = '';
            selectedPhotoFile = null;

            alert('Photo saved successfully! üéâ');
            loadProgressPhotos();
        }

        function deletePhoto(index) {
            if (confirm('Are you sure you want to delete this photo?')) {
                const photos = JSON.parse(localStorage.getItem(`photos_${currentUser.email}`) || '[]');
                photos.splice(index, 1);
                localStorage.setItem(`photos_${currentUser.email}`, JSON.stringify(photos));
                loadProgressPhotos();
            }
        }

        function updateComparisonSelects() {
            const photos = JSON.parse(localStorage.getItem(`photos_${currentUser.email}`) || '[]');
            const beforeSelect = document.getElementById('beforePhoto');
            const afterSelect = document.getElementById('afterPhoto');

            if (beforeSelect && afterSelect) {
                const options = photos.map((photo, index) => 
                    `<option value="${index}">${new Date(photo.date).toLocaleDateString()} - ${photo.weight} lbs</option>`
                ).join('');

                beforeSelect.innerHTML = '<option value="">Select first photo...</option>' + options;
                afterSelect.innerHTML = '<option value="">Select second photo...</option>' + options;
            }
        }

        function updateComparison() {
            const beforeIndex = document.getElementById('beforePhoto').value;
            const afterIndex = document.getElementById('afterPhoto').value;
            const comparisonView = document.getElementById('comparisonView');

            if (beforeIndex && afterIndex && beforeIndex !== afterIndex) {
                const photos = JSON.parse(localStorage.getItem(`photos_${currentUser.email}`) || '[]');
                const beforePhoto = photos[beforeIndex];
                const afterPhoto = photos[afterIndex];

                const weightDiff = (afterPhoto.weight - beforePhoto.weight).toFixed(1);
                const days = Math.floor((new Date(afterPhoto.date) - new Date(beforePhoto.date)) / (1000 * 60 * 60 * 24));

                comparisonView.innerHTML = `
                    <div class="comparison-card">
                        <img src="${beforePhoto.image}" alt="Before">
                        <div class="comparison-info">
                            <strong>BEFORE</strong>
                            <div>${new Date(beforePhoto.date).toLocaleDateString()}</div>
                            <div>${beforePhoto.weight} lbs</div>
                        </div>
                    </div>
                    <div class="comparison-card">
                        <img src="${afterPhoto.image}" alt="After">
                        <div class="comparison-info">
                            <strong>AFTER</strong>
                            <div>${new Date(afterPhoto.date).toLocaleDateString()}</div>
                            <div>${afterPhoto.weight} lbs</div>
                            <div style="color: ${weightDiff < 0 ? '#28a745' : '#dc3545'}; font-weight: bold; margin-top: 10px;">
                                ${weightDiff > 0 ? '+' : ''}${weightDiff} lbs in ${days} days
                            </div>
                        </div>
                    </div>
                `;
            } else {
                comparisonView.innerHTML = '';
            }
        }

        function openPhotoModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('photoModal').classList.add('active');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
        }
        // Settings Functions
        function showSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('settingsEmail').textContent = currentUser.email;
            document.getElementById('settingsMemberSince').textContent = new Date(currentUser.createdAt).toLocaleDateString();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
            document.getElementById('settingsError').style.display = 'none';
            document.getElementById('settingsSuccess').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showSettingsError('Please fill in all fields');
                return;
            }

            if (currentUser.password !== currentPassword) {
                showSettingsError('Current password is incorrect');
                return;
            }

            if (newPassword.length < 6) {
                showSettingsError('New password must be at least 6 characters');
                return;
            }

            if (newPassword !== confirmPassword) {
                showSettingsError('New passwords do not match');
                return;
            }

            if (newPassword === currentPassword) {
                showSettingsError('New password must be different from current');
                return;
            }

            // Update password
            currentUser.password = newPassword;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            users[currentUser.email].password = newPassword;
            localStorage.setItem('users', JSON.stringify(users));

            showSettingsSuccess('Password updated successfully!');
            
            setTimeout(() => {
                closeSettingsModal();
            }, 2000);
        }

        function showSettingsError(message) {
            const errorEl = document.getElementById('settingsError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('settingsSuccess').style.display = 'none';
        }

        function showSettingsSuccess(message) {
            const successEl = document.getElementById('settingsSuccess');
            successEl.textContent = message;
            successEl.style.display = 'block';
            document.getElementById('settingsError').style.display = 'none';
        }

        // Admin Functions (simplified)
        function loadAdminDashboard() {
            console.log('Admin dashboard loaded');
            // Admin panel features can be added later
            loadDashboard();
        }

        // Initialize on page load
        window.onload = function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.onboardingComplete) {
                    if (currentUser.isAdmin) {
                        loadAdminDashboard();
                    } else {
                        loadDashboard();
                    }
                    showPage('dashboard');
                } else {
                    startOnboarding();
                    showPage('onboarding');
                }
            } else {
                showPage('login');
            }

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker error:', err));
            }

            // PWA Install Prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install banner after 3 seconds on dashboard
                setTimeout(() => {
                    if (currentUser && currentPage === 'dashboard') {
                        const banner = document.createElement('div');
                        banner.id = 'installBanner';
                        banner.innerHTML = `
                            <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%); color: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 999; max-width: 90%; text-align: center;">
                                <strong>üì± Install THE LAST COACH</strong>
                                <p style="margin: 10px 0; font-size: 14px;">Add to your home screen!</p>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button onclick="installPWA()" style="background: white; color: #FF6B35; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">Install</button>
                                    <button onclick="dismissInstallPrompt()" style="background: transparent; color: white; border: 2px solid white; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">Later</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(banner);
                    }
                }, 3000);
            });

            window.installPWA = async function() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    dismissInstallPrompt();
                }
            };

            window.dismissInstallPrompt = function() {
                const banner = document.getElementById('installBanner');
                if (banner) banner.remove();
            };
        };
    </script>
</body>
</html>
