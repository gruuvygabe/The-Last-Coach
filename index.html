<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE LAST COACH</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Your personal fitness tracker - Track progress photos, weight, and achieve your fitness goals">
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Last Coach">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- App Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 42px;
            margin-bottom: 10px;
        }

        .header .emoji {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: #666;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab.active {
            color: #FF6B35;
            border-bottom-color: #FF6B35;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FF6B35;
        }

        .btn {
            background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            width: 100%;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step h2 {
            color: #FF6B35;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .step-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .option-card.selected {
            background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%);
            color: white;
            border-color: #1a1a1a;
        }

        .option-card .emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .checkbox-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item.selected {
            background: #e3e8ff;
            border-color: #FF6B35;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FF6B35;
            cursor: pointer;
        }

        .slider-value {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #FF6B35;
            margin-top: 10px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .nav-tab {
            background: rgba(255,255,255,0.9);
            color: #FF6B35;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: white;
            color: #333;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
        }

        .modal-close:hover {
            background: #f0f0f0;
        }

        @media (max-width: 768px) {
            .card {
                padding: 25px;
            }
            .two-column {
                grid-template-columns: 1fr;
            }
            .nav-tabs {
                gap: 5px;
            }
            .nav-tab {
                padding: 12px 15px;
                font-size: 14px;
            }
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            background: rgba(255,255,255,0.9);
            color: #FF6B35;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
            min-height: 48px;
            flex-shrink: 0;
        }

        .nav-tab.active {
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Page -->
        <div id="loginPage" class="page active">
            <div class="header">
                <div class="emoji">üí™</div>
                <h1>THE LAST COACH</h1>
                <p>Your personalized fitness journey</p>
            </div>

            <div class="card">
                <div class="tabs">
                    <div class="tab active" onclick="switchAuthTab('signin')">Sign In</div>
                    <div class="tab" onclick="switchAuthTab('signup')">Sign Up</div>
                </div>

                <div id="authError" class="error-message"></div>

                <!-- Sign In -->
                <div id="signin" class="form-section active">
                    <form onsubmit="handleSignIn(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="signinEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="signinPassword" required>
                        </div>
                        <button type="submit" class="btn">Sign In</button>
                    </form>
                </div>

                <!-- Sign Up -->
                <div id="signup" class="form-section">
                    <form onsubmit="handleSignUp(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="signupEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="signupPassword" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="signupPasswordConfirm" required minlength="6">
                        </div>
                        <button type="submit" class="btn">Create Account</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Onboarding Page -->
        <div id="onboardingPage" class="page">
            <div class="header">
                <h1>üí™ THE LAST COACH</h1>
                <p>Let's create your personalized plan</p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="card" id="onboardingCard">
                <!-- Steps will be dynamically loaded here -->
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page">
            <div class="header" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 style="color: #FF6B35; font-size: 28px;">THE LAST COACH üí™</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="width: auto; padding: 10px 20px; background: #6c757d; font-size: 14px; margin: 0;" onclick="showSettings()">‚öôÔ∏è Settings</button>
                    <button class="btn" style="width: auto; padding: 10px 20px; background: #ff6b6b; font-size: 14px; margin: 0;" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchDashTab('overview')">üìä Dashboard</button>
                <button class="nav-tab" onclick="switchDashTab('photos')">üì∏ Photos</button>
                <button class="nav-tab" onclick="switchDashTab('nutrition')">üçé Nutrition</button>
                <button class="nav-tab" onclick="switchDashTab('workouts')">üí™ Workouts</button>
            </div>

            <!-- Dashboard Overview Tab -->
            <div id="overview" class="tab-content active">
            <div class="card">
                <h2 style="color: #FF6B35;">Welcome back, <span id="dashboardName">User</span>! üëã</h2>
                <p style="color: #666; margin-top: 10px;">Here's your personalized plan</p>
            </div>

            <div id="coachMessages" class="card" style="display: none;">
                <h2 style="color: #FF6B35;">üí¨ Messages from Your Coach</h2>
                <div id="userMessagesList"></div>
            </div>

            <div id="coachComments" class="card" style="display: none;">
                <h2 style="color: #FF6B35;">üí™ Motivational Comments</h2>
                <div id="userCommentsList"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="dashCurrentWeight">--</div>
                    <div class="stat-label">Current Weight (lbs)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dashGoalWeight">--</div>
                    <div class="stat-label">Goal Weight (lbs)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dashCalories">--</div>
                    <div class="stat-label">Daily Calories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dashWorkouts">--</div>
                    <div class="stat-label">Workouts/Week</div>
                </div>
            </div>

            <div class="card">
                <h2 style="color: #FF6B35;">Your Profile Complete! üéâ</h2>
                <p style="margin-top: 15px; color: #666;">
                    You've completed your personalized assessment. Your custom workout and nutrition plans 
                    are being prepared based on your goals, equipment, and preferences.
                </p>
                <div style="margin-top: 20px; padding: 15px; background: #e3e8ff; border-radius: 10px;">
                    <strong style="color: #FF6B35;">Next Steps:</strong>
                    <ul style="margin-top: 10px; margin-left: 20px; color: #333;">
                        <li>Track your progress with photos</li>
                        <li>Follow your personalized meal plans</li>
                        <li>Complete your custom workouts</li>
                        <li>Stay consistent and watch the results!</li>
                    </ul>
                </div>
            </div>
            </div>
            <!-- End Overview Tab -->

            <!-- Progress Photos Tab -->
            <div id="photos" class="tab-content">
                <div class="card">
                    <h2 style="color: #FF6B35;">Upload Progress Photo</h2>
                    
                    <div id="uploadArea" style="border: 3px dashed #FF6B35; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px;" onclick="document.getElementById('photoInput').click()">
                        <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoSelect(event)">
                        <h3>üì∏ Click to Upload Photo</h3>
                        <p>Take a new photo or select from gallery</p>
                    </div>

                    <div class="form-group">
                        <label>Current Weight (lbs)</label>
                        <input type="number" id="photoWeight" step="0.1" placeholder="Enter your current weight">
                    </div>

                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="photoNotes" rows="3" placeholder="How are you feeling?"></textarea>
                    </div>

                    <button class="btn" onclick="saveProgressPhoto()">Save Progress Photo</button>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Before & After Comparison</h2>
                    <div class="form-group">
                        <label>Select First Photo</label>
                        <select id="beforePhoto" onchange="updateComparison()">
                            <option value="">Select a photo...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Select Second Photo</label>
                        <select id="afterPhoto" onchange="updateComparison()">
                            <option value="">Select a photo...</option>
                        </select>
                    </div>
                    <div id="comparisonView" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;"></div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">All Progress Photos</h2>
                    <div id="allPhotos" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;"></div>
                </div>
            </div>
            <!-- End Photos Tab -->

            <!-- Nutrition Tab -->
            <div id="nutrition" class="tab-content">
                <div class="card">
                    <h2 style="color: #FF6B35;">üçé Nutrition Plan</h2>
                    <p style="color: #666; margin: 20px 0;">Your personalized meal plans are coming soon!</p>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <strong>Daily Calorie Target:</strong> <span id="nutritionCalories" style="color: #FF6B35; font-size: 24px; font-weight: bold;">--</span> calories
                    </div>
                </div>
            </div>
            <!-- End Nutrition Tab -->

            <!-- Workouts Tab -->
            <div id="workouts" class="tab-content">
                <div class="card">
                    <h2 style="color: #FF6B35;">üí™ Workout Programs</h2>
                    <p style="color: #666; margin: 20px 0;">Your customized workout routines are coming soon!</p>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <strong>Workouts Per Week:</strong> <span id="workoutDaysDisplay" style="color: #FF6B35; font-size: 24px; font-weight: bold;">--</span> days
                    </div>
                </div>
            </div>
            <!-- End Workouts Tab -->

        </div>
    </div>

    <script>
        let currentUser = null;
        let currentPage = 'login';
        let currentStep = 1;
        const totalSteps = 8;
        const userData = {};
        let progressPhotos = [];
        let selectedPhotoFile = null;

        // Page Navigation
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            currentPage = pageName;
        }

        // Auth Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.getElementById('authError').style.display = 'none';
        }

        function handleSignIn(event) {
            event.preventDefault();
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            const users = JSON.parse(localStorage.getItem('users') || '{}');

            // Check for admin credentials
            if (email === 'admin@thelastcoach.com' && password === 'admin123') {
                currentUser = {
                    email: email,
                    isAdmin: true,
                    approved: true,
                    locked: false,
                    name: 'Admin',
                    onboardingComplete: true,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                loadAdminDashboard();
                showPage('dashboard');
                return;
            }

            if (!users[email]) {
                showAuthError('No account found. Please sign up first.');
                return;
            }

            if (users[email].password !== password) {
                showAuthError('Incorrect password.');
                return;
            }

            // Check if account is locked
            if (users[email].locked) {
                showAuthError('Your account has been locked. Please contact support.');
                return;
            }

            // Check if account is approved (unless they're admin)
            if (!users[email].approved && !users[email].isAdmin) {
                showAuthError('Your account is pending approval. Please wait for admin approval.');
                return;
            }

            currentUser = users[email];
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            if (currentUser.onboardingComplete) {
                loadDashboard();
                showPage('dashboard');
            } else {
                startOnboarding();
                showPage('onboarding');
            }
        }

        function handleSignUp(event) {
            event.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showAuthError('Passwords do not match.');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');

            if (users[email]) {
                showAuthError('Account already exists. Please sign in.');
                return;
            }

            const newUser = {
                email: email,
                password: password,
                createdAt: new Date().toISOString(),
                onboardingComplete: false,
                approved: false,
                locked: false
            };

            users[email] = newUser;
            localStorage.setItem('users', JSON.stringify(users));

            // Show pending approval message instead of letting them in
            showAuthError('Account created! Please wait for admin approval before signing in.');
        }

        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                showPage('login');
            }
        }

        // Dashboard Tab Switching
        function switchDashTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Load specific tab content
            if (tabName === 'photos') {
                loadProgressPhotos();
                setupPhotoUpload();
            } else if (tabName === 'nutrition') {
                const caloriesEl = document.getElementById('nutritionCalories');
                if (caloriesEl && currentUser) {
                    caloriesEl.textContent = currentUser.calorieTarget || '--';
                }
            } else if (tabName === 'workouts') {
                const workoutsEl = document.getElementById('workoutDaysDisplay');
                if (workoutsEl && currentUser) {
                    workoutsEl.textContent = currentUser.workoutDays || '--';
                }
            }
        }

        // Onboarding Functions
        function startOnboarding() {
            currentStep = 1;
            updateProgress();
            renderOnboardingStep();
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function renderOnboardingStep() {
            const card = document.getElementById('onboardingCard');
            
            if (currentStep === 1) {
                card.innerHTML = `
                    <h2>Welcome! Let's start with the basics</h2>
                    <p class="step-subtitle">This helps us understand where you're starting from</p>
                    
                    <div class="form-group">
                        <label>What's your name?</label>
                        <input type="text" id="userName" placeholder="Enter your first name">
                    </div>

                    <div class="two-column">
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" id="userAge" placeholder="Years">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="userGender">
                                <option value="">Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Current Weight (lbs)</label>
                        <input type="number" id="currentWeight" step="0.1">
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                `;
            } else if (currentStep === 2) {
                card.innerHTML = `
                    <h2>What are your goals?</h2>
                    <p class="step-subtitle">Tell us what you want to achieve</p>
                    
                    <div class="form-group">
                        <label>Goal Weight (lbs)</label>
                        <input type="number" id="goalWeight" step="0.1">
                    </div>

                    <div class="form-group">
                        <label>How many days per week can you work out?</label>
                        <div class="slider-container">
                            <input type="range" min="2" max="7" value="4" class="slider" id="workoutDays" oninput="updateSlider('workoutDays', 'workoutDaysValue', ' days/week')">
                            <div class="slider-value" id="workoutDaysValue">4 days/week</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>What's your primary goal?</label>
                        <div class="options-grid">
                            <div class="option-card" onclick="selectGoal('weight-loss', this)">
                                <div class="emoji">üéØ</div>
                                <div>Weight Loss</div>
                            </div>
                            <div class="option-card" onclick="selectGoal('muscle-gain', this)">
                                <div class="emoji">üí™</div>
                                <div>Build Muscle</div>
                            </div>
                            <div class="option-card" onclick="selectGoal('general-health', this)">
                                <div class="emoji">‚ù§Ô∏è</div>
                                <div>General Health</div>
                            </div>
                        </div>
                    </div>

                    <button class="btn" onclick="nextOnboardingStep()">Continue</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
                updateSlider('workoutDays', 'workoutDaysValue', ' days/week');
            } else if (currentStep === 3) {
                card.innerHTML = `
                    <h2>What's your motivation?</h2>
                    <p class="step-subtitle">Understanding your "why" helps keep you accountable</p>
                    
                    <div class="form-group">
                        <label>What's your primary motivation for this transformation?</label>
                        <textarea id="motivation" rows="4" placeholder="Be specific... What will achieving your goals mean for you?"></textarea>
                    </div>

                    <button class="btn" onclick="completeOnboarding()">Complete Setup</button>
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">Back</button>
                `;
            }
        }

        function updateSlider(sliderId, valueId, suffix) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            if (slider && valueDisplay) {
                valueDisplay.textContent = slider.value + suffix;
            }
        }

        function selectGoal(goal, element) {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            userData.primaryGoal = goal;
        }

        function nextOnboardingStep() {
            // Save current step data
            if (currentStep === 1) {
                userData.name = document.getElementById('userName').value;
                userData.age = document.getElementById('userAge').value;
                userData.gender = document.getElementById('userGender').value;
                userData.currentWeight = document.getElementById('currentWeight').value;

                if (!userData.name || !userData.age || !userData.gender || !userData.currentWeight) {
                    alert('Please fill in all fields');
                    return;
                }
            } else if (currentStep === 2) {
                userData.goalWeight = document.getElementById('goalWeight').value;
                userData.workoutDays = document.getElementById('workoutDays').value;

                if (!userData.goalWeight || !userData.primaryGoal) {
                    alert('Please fill in all fields and select a goal');
                    return;
                }
            }

            currentStep++;
            updateProgress();
            renderOnboardingStep();
        }

        function prevOnboardingStep() {
            currentStep--;
            updateProgress();
            renderOnboardingStep();
        }

        function completeOnboarding() {
            console.log('Complete onboarding called');
            console.log('Current userData:', userData);
            
            userData.motivation = document.getElementById('motivation').value;

            if (!userData.motivation) {
                alert('Please share your motivation');
                return;
            }

            console.log('Calculating metrics...');
            
            // Calculate basic metrics with better defaults
            const weightDiff = userData.currentWeight - userData.goalWeight;
            userData.calorieTarget = weightDiff > 0 ? 2000 : 2500; // Simplified
            userData.onboardingComplete = true;

            console.log('Updating user...');
            
            // Update user
            currentUser = { ...currentUser, ...userData };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            users[currentUser.email] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));

            console.log('Loading dashboard...');
            
            try {
                loadDashboard();
                showPage('dashboard');
                console.log('Dashboard loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading dashboard. Please check console.');
            }
        }

        function loadDashboard() {
            try {
                // Safely set dashboard values with null checks
                const nameEl = document.getElementById('dashboardName');
                if (nameEl) nameEl.textContent = currentUser.name || 'User';
                
                const currentWeightEl = document.getElementById('dashCurrentWeight');
                if (currentWeightEl) currentWeightEl.textContent = currentUser.currentWeight || '--';
                
                const goalWeightEl = document.getElementById('dashGoalWeight');
                if (goalWeightEl) goalWeightEl.textContent = currentUser.goalWeight || '--';
                
                const caloriesEl = document.getElementById('dashCalories');
                if (caloriesEl) caloriesEl.textContent = currentUser.calorieTarget || '--';
                
                const workoutsEl = document.getElementById('dashWorkouts');
                if (workoutsEl) workoutsEl.textContent = currentUser.workoutDays || '--';
                
                const emailEl = document.getElementById('userEmail');
                if (emailEl) emailEl.textContent = currentUser.email || '';
                
                // Calculate weight to go
                if (currentUser.currentWeight && currentUser.goalWeight) {
                    const weightToGo = Math.abs(currentUser.currentWeight - currentUser.goalWeight).toFixed(1);
                    const weightToGoEl = document.getElementById('dashWeightToGo');
                    if (weightToGoEl) weightToGoEl.textContent = weightToGo;
                }
                
                // Load messages from coach
                try {
                    loadUserMessages();
                } catch (msgError) {
                    console.log('Messages not loaded:', msgError);
                }
                
                // Load progress photos
                try {
                    loadProgressPhotos();
                    setupPhotoUpload();
                } catch (photoError) {
                    console.log('Photos not loaded:', photoError);
                }
            } catch (error) {
                console.error('Dashboard loading error:', error);
                // Don't show alert - just log it
                // Continue anyway - partial dashboard is better than nothing
            }
        }

        function loadUserMessages() {
            // Load messages
            const userMessages = localStorage.getItem(`messages_${currentUser.email}`);
            const messages = userMessages ? JSON.parse(userMessages) : [];
            
            // Load comments
            const userComments = localStorage.getItem(`comments_${currentUser.email}`);
            const comments = userComments ? JSON.parse(userComments) : [];

            // Show messages if any exist
            if (messages.length > 0) {
                const messagesCard = document.getElementById('coachMessages');
                messagesCard.style.display = 'block';
                
                const unreadMessages = messages.filter(m => !m.read);
                
                document.getElementById('userMessagesList').innerHTML = messages.slice(-5).reverse().map(msg => `
                    <div style="background: ${msg.read ? '#f8f9fa' : '#e3e8ff'}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #FF6B35;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #FF6B35;">${msg.type.toUpperCase()}</strong>
                            <small style="color: #666;">${new Date(msg.date).toLocaleDateString()}</small>
                        </div>
                        <p style="margin-top: 10px; color: #333;">${msg.message}</p>
                        ${!msg.read ? '<span style="color: #FF6B35; font-weight: bold; font-size: 12px;">NEW</span>' : ''}
                    </div>
                `).join('');
                
                // Mark messages as read
                messages.forEach(m => m.read = true);
                localStorage.setItem(`messages_${currentUser.email}`, JSON.stringify(messages));
            }

            // Show comments if any exist
            if (comments.length > 0) {
                const commentsCard = document.getElementById('coachComments');
                commentsCard.style.display = 'block';
                
                document.getElementById('userCommentsList').innerHTML = comments.slice(-5).reverse().map(comment => `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #FF6B35;">Your Coach</strong>
                            <small style="color: #666;">${new Date(comment.date).toLocaleDateString()}</small>
                        </div>
                        <p style="margin-top: 10px; color: #333;">${comment.comment}</p>
                    </div>
                `).join('');
            }
        }

        function loadAdminDashboard() {
            document.getElementById('userEmail').textContent = 'admin@thelastcoach.com';
            
            // Get all users
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const userList = Object.values(users);
            
            // Update dashboard with admin stats
            document.getElementById('dashboardName').textContent = 'Admin';
            document.getElementById('dashCurrentWeight').textContent = userList.length;
            document.querySelector('#dashCurrentWeight').parentElement.querySelector('.stat-label').textContent = 'Total Users';
            
            const completedUsers = userList.filter(u => u.onboardingComplete).length;
            document.getElementById('dashGoalWeight').textContent = completedUsers;
            document.querySelector('#dashGoalWeight').parentElement.querySelector('.stat-label').textContent = 'Completed Onboarding';
            
            const totalPhotos = userList.reduce((sum, user) => {
                const photos = localStorage.getItem(`photos_${user.email}`);
                return sum + (photos ? JSON.parse(photos).length : 0);
            }, 0);
            document.getElementById('dashWeightToGo').textContent = totalPhotos;
            document.querySelector('#dashWeightToGo').parentElement.querySelector('.stat-label').textContent = 'Total Photos';
            
            document.getElementById('dashTotalPhotos').textContent = userList.length > 0 ? '‚úì' : '0';
            document.querySelector('#dashTotalPhotos').parentElement.querySelector('.stat-label').textContent = 'System Active';
            
            // Show user list with management options
            const recentPhotos = document.getElementById('recentPhotos');
            recentPhotos.innerHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;"><h3 style="margin-bottom: 15px; color: #FF6B35;">All Users</h3>' + 
                userList.map(user => {
                    const userPhotos = localStorage.getItem(`photos_${user.email}`);
                    const photoCount = userPhotos ? JSON.parse(userPhotos).length : 0;
                    
                    return `
                    <div style="padding: 15px; background: white; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #FF6B35;">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                            <div style="flex: 1;">
                                <strong>${user.name || 'No name'}</strong> (${user.email})<br>
                                <small style="color: #666;">
                                    ${user.onboardingComplete ? '‚úÖ Onboarding Complete' : '‚è≥ Onboarding Incomplete'}<br>
                                    Weight: ${user.currentWeight || 'N/A'} lbs ‚Üí ${user.goalWeight || 'N/A'} lbs<br>
                                    Photos: ${photoCount}<br>
                                    Joined: ${new Date(user.createdAt).toLocaleDateString()}
                                </small>
                            </div>
                            <button class="btn" style="width: auto; padding: 10px 20px; margin: 0; font-size: 14px;" 
                                    onclick="viewUserDetails('${user.email}')">
                                View Profile
                            </button>
                        </div>
                    </div>
                `;
                }).join('') + '</div>';
            
            // Hide photo upload for admin
            document.querySelector('[onclick="switchDashTab(\'photos\')"]').style.display = 'none';
        }

        function viewUserDetails(email) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[email];
            
            if (!user) {
                alert('User not found');
                return;
            }

            // Load user's photos
            const userPhotos = localStorage.getItem(`photos_${email}`);
            const photos = userPhotos ? JSON.parse(userPhotos) : [];
            
            // Load user's messages
            const userMessages = localStorage.getItem(`messages_${email}`);
            const messages = userMessages ? JSON.parse(userMessages) : [];

            // Show user detail view
            const overview = document.getElementById('overview');
            overview.innerHTML = `
                <div class="card">
                    <button class="btn btn-secondary" style="width: auto; padding: 10px 20px; margin-bottom: 20px;" onclick="loadAdminDashboard(); loadDashboard();">
                        ‚Üê Back to All Users
                    </button>
                    <h2 style="color: #FF6B35;">Managing: ${user.name || 'User'}</h2>
                    <p style="color: #666; margin-top: 10px;">${user.email}</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${user.currentWeight || '--'}</div>
                        <div class="stat-label">Current Weight (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${user.goalWeight || '--'}</div>
                        <div class="stat-label">Goal Weight (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${user.currentWeight && user.goalWeight ? Math.abs(user.currentWeight - user.goalWeight).toFixed(1) : '--'}</div>
                        <div class="stat-label">Weight to Go (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${photos.length}</div>
                        <div class="stat-label">Progress Photos</div>
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">User Details</h2>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px;">
                        <strong>Personal Info:</strong><br>
                        Age: ${user.age || 'N/A'}<br>
                        Gender: ${user.gender || 'N/A'}<br>
                        Height: ${user.heightFeet || 'N/A'}' ${user.heightInches || 'N/A'}"<br><br>
                        <strong>Goals:</strong><br>
                        Primary Goal: ${user.primaryGoal || 'N/A'}<br>
                        Workouts/Week: ${user.workoutDays || 'N/A'}<br>
                        Calories: ${user.calorieTarget || 'N/A'}<br><br>
                        <strong>Motivation:</strong><br>
                        "${user.motivation || 'Not provided'}"
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Send Message to ${user.name || 'User'}</h2>
                    <div class="form-group">
                        <label>Message Type</label>
                        <select id="messageType">
                            <option value="motivation">Motivational Message</option>
                            <option value="checkin">Check-in</option>
                            <option value="congrats">Congratulations</option>
                            <option value="general">General Message</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Your Message</label>
                        <textarea id="adminMessage" rows="4" placeholder="Write your message here..."></textarea>
                    </div>
                    <button class="btn" onclick="sendMessageToUser('${email}')">Send Message</button>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Message History</h2>
                    <div id="messageHistory">
                        ${messages.length === 0 ? 
                            '<p style="color: #999; text-align: center;">No messages sent yet</p>' :
                            messages.map(msg => `
                                <div style="background: #e3e8ff; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #FF6B35;">
                                    <strong style="color: #FF6B35;">${msg.type.toUpperCase()}</strong>
                                    <small style="color: #666; float: right;">${new Date(msg.date).toLocaleString()}</small>
                                    <p style="margin-top: 10px; color: #333;">${msg.message}</p>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">${user.name || 'User'}'s Progress Photos</h2>
                    <div class="progress-photos-grid">
                        ${photos.length === 0 ? 
                            '<p style="color: #999; text-align: center;">No photos uploaded yet</p>' :
                            photos.map(photo => `
                                <div class="photo-card" onclick="openPhotoModal('${photo.imageData}')">
                                    <img src="${photo.imageData}" alt="Progress photo">
                                    <div class="photo-info">
                                        <div class="photo-date">${new Date(photo.date).toLocaleDateString()}</div>
                                        <div class="photo-weight">${photo.weight} lbs</div>
                                        ${photo.notes ? `<small style="color: #666;">${photo.notes}</small>` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: #FF6B35;">Leave Motivational Comment</h2>
                    <div class="form-group">
                        <label>Your Comment</label>
                        <textarea id="motivationalComment" rows="3" placeholder="Leave an encouraging comment on their progress..."></textarea>
                    </div>
                    <button class="btn" onclick="addMotivationalComment('${email}')">Post Comment</button>
                    
                    <div id="commentsList" style="margin-top: 20px;">
                        ${getMotivationalComments(email)}
                    </div>
                </div>
            `;
        }

        function sendMessageToUser(email) {
            const messageType = document.getElementById('messageType').value;
            const messageText = document.getElementById('adminMessage').value;

            if (!messageText.trim()) {
                alert('Please enter a message');
                return;
            }

            // Get existing messages
            const userMessages = localStorage.getItem(`messages_${email}`);
            const messages = userMessages ? JSON.parse(userMessages) : [];

            // Add new message
            const newMessage = {
                id: Date.now(),
                type: messageType,
                message: messageText,
                date: new Date().toISOString(),
                read: false
            };

            messages.push(newMessage);
            localStorage.setItem(`messages_${email}`, JSON.stringify(messages));

            // Clear form
            document.getElementById('adminMessage').value = '';

            alert('Message sent successfully!');
            
            // Refresh the view
            viewUserDetails(email);
        }

        function addMotivationalComment(email) {
            const commentText = document.getElementById('motivationalComment').value;

            if (!commentText.trim()) {
                alert('Please enter a comment');
                return;
            }

            // Get existing comments
            const userComments = localStorage.getItem(`comments_${email}`);
            const comments = userComments ? JSON.parse(userComments) : [];

            // Add new comment
            const newComment = {
                id: Date.now(),
                comment: commentText,
                date: new Date().toISOString(),
                from: 'Coach'
            };

            comments.push(newComment);
            localStorage.setItem(`comments_${email}`, JSON.stringify(comments));

            // Clear form
            document.getElementById('motivationalComment').value = '';

            alert('Comment posted successfully!');
            
            // Refresh the view
            viewUserDetails(email);
        }

        function getMotivationalComments(email) {
            const userComments = localStorage.getItem(`comments_${email}`);
            const comments = userComments ? JSON.parse(userComments) : [];

            if (comments.length === 0) {
                return '<p style="color: #999; text-align: center;">No comments yet</p>';
            }

            return comments.map(comment => `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <strong style="color: #FF6B35;">Coach</strong>
                    <small style="color: #666; float: right;">${new Date(comment.date).toLocaleString()}</small>
                    <p style="margin-top: 10px; color: #333;">${comment.comment}</p>
                </div>
            `).join('');
        }

        // Progress Photo Functions
        function loadProgressPhotos() {
            const savedPhotos = localStorage.getItem(`photos_${currentUser.email}`);
            if (savedPhotos) {
                progressPhotos = JSON.parse(savedPhotos);
            } else {
                progressPhotos = [];
            }
            renderPhotos();
            updatePhotoStats();
        }

        function setupPhotoUpload() {
            const uploadArea = document.getElementById('uploadArea');
            
            // If upload area doesn't exist (not on photos tab), skip
            if (!uploadArea) {
                console.log('Upload area not found - user not on photos tab');
                return;
            }
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = '#e3e8ff';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = '';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = '';
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handlePhotoFile(files[0]);
                }
            });
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handlePhotoFile(file);
            }
        }

        function handlePhotoFile(file) {
            selectedPhotoFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.innerHTML = `
                    <img src="${e.target.result}" style="max-width: 100%; max-height: 300px; border-radius: 10px;">
                    <p style="margin-top: 10px;">Photo selected! Add details and save.</p>
                `;
            };
            reader.readAsDataURL(file);
        }

        function saveProgressPhoto() {
            if (!selectedPhotoFile) {
                alert('Please select a photo first');
                return;
            }

            const weight = document.getElementById('photoWeight').value;
            if (!weight) {
                alert('Please enter your current weight');
                return;
            }

            const notes = document.getElementById('photoNotes').value;

            const reader = new FileReader();
            reader.onload = function(e) {
                const photo = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    weight: parseFloat(weight),
                    notes: notes,
                    imageData: e.target.result
                };

                progressPhotos.push(photo);
                progressPhotos.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                localStorage.setItem(`photos_${currentUser.email}`, JSON.stringify(progressPhotos));

                // Reset form
                selectedPhotoFile = null;
                document.getElementById('photoWeight').value = '';
                document.getElementById('photoNotes').value = '';
                document.getElementById('uploadArea').innerHTML = `
                    <h3>üì∏ Click or Drag to Upload</h3>
                    <p>Take a new photo or select from gallery</p>
                `;
                document.getElementById('photoInput').value = '';

                renderPhotos();
                updatePhotoStats();
                alert('Progress photo saved successfully!');
            };
            reader.readAsDataURL(selectedPhotoFile);
        }

        function renderPhotos() {
            renderAllPhotos();
            renderRecentPhotos();
            renderTimeline();
            updateComparisonSelects();
        }

        function renderAllPhotos() {
            const container = document.getElementById('allPhotos');
            if (progressPhotos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No photos yet. Upload your first progress photo!</p>';
                return;
            }

            container.innerHTML = progressPhotos.map(photo => `
                <div class="photo-card" onclick="openPhotoModal('${photo.imageData}')">
                    <button class="delete-photo" onclick="event.stopPropagation(); deletePhoto(${photo.id})">√ó</button>
                    <img src="${photo.imageData}" alt="Progress photo">
                    <div class="photo-info">
                        <div class="photo-date">${new Date(photo.date).toLocaleDateString()}</div>
                        <div class="photo-weight">${photo.weight} lbs</div>
                    </div>
                </div>
            `).join('');
        }

        function renderRecentPhotos() {
            const container = document.getElementById('recentPhotos');
            const recent = progressPhotos.slice(-4);
            
            if (recent.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No photos yet</p>';
                return;
            }

            container.innerHTML = recent.map(photo => `
                <div class="photo-card" onclick="openPhotoModal('${photo.imageData}')">
                    <img src="${photo.imageData}" alt="Progress photo">
                    <div class="photo-info">
                        <div class="photo-date">${new Date(photo.date).toLocaleDateString()}</div>
                        <div class="photo-weight">${photo.weight} lbs</div>
                    </div>
                </div>
            `).join('');
        }

        function renderTimeline() {
            const container = document.getElementById('photoTimeline');
            if (progressPhotos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No timeline data yet</p>';
                return;
            }

            container.innerHTML = progressPhotos.map((photo, index) => {
                const weightChange = index > 0 ? 
                    (photo.weight - progressPhotos[index - 1].weight).toFixed(1) : 0;
                const changeText = weightChange > 0 ? `+${weightChange} lbs` : 
                                  weightChange < 0 ? `${weightChange} lbs` : 'Starting point';
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-marker">${index + 1}</div>
                        <div class="timeline-content">
                            <strong>${new Date(photo.date).toLocaleDateString()}</strong>
                            <div>Weight: ${photo.weight} lbs ${index > 0 ? `(${changeText})` : ''}</div>
                            ${photo.notes ? `<div style="margin-top: 5px; color: #666;">${photo.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateComparisonSelects() {
            const beforeSelect = document.getElementById('beforePhoto');
            const afterSelect = document.getElementById('afterPhoto');

            const options = progressPhotos.map((photo, index) => 
                `<option value="${index}">${new Date(photo.date).toLocaleDateString()} - ${photo.weight} lbs</option>`
            ).join('');

            beforeSelect.innerHTML = '<option value="">Select a photo...</option>' + options;
            afterSelect.innerHTML = '<option value="">Select a photo...</option>' + options;
        }

        function updateComparison() {
            const beforeIndex = document.getElementById('beforePhoto').value;
            const afterIndex = document.getElementById('afterPhoto').value;
            const container = document.getElementById('comparisonView');

            if (!beforeIndex || !afterIndex) {
                container.innerHTML = '';
                return;
            }

            const beforePhoto = progressPhotos[beforeIndex];
            const afterPhoto = progressPhotos[afterIndex];
            const weightDiff = (afterPhoto.weight - beforePhoto.weight).toFixed(1);
            const daysDiff = Math.round((new Date(afterPhoto.date) - new Date(beforePhoto.date)) / (1000 * 60 * 60 * 24));

            container.innerHTML = `
                <div class="comparison-card">
                    <img src="${beforePhoto.imageData}" alt="Before">
                    <div class="comparison-info">
                        <h3>Before</h3>
                        <p>${new Date(beforePhoto.date).toLocaleDateString()}</p>
                        <p><strong>${beforePhoto.weight} lbs</strong></p>
                    </div>
                </div>
                <div class="comparison-card">
                    <img src="${afterPhoto.imageData}" alt="After">
                    <div class="comparison-info">
                        <h3>After</h3>
                        <p>${new Date(afterPhoto.date).toLocaleDateString()}</p>
                        <p><strong>${afterPhoto.weight} lbs</strong></p>
                        <p style="color: ${weightDiff < 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                            ${weightDiff > 0 ? '+' : ''}${weightDiff} lbs
                        </p>
                        <p style="color: #666; font-size: 14px;">${daysDiff} days</p>
                    </div>
                </div>
            `;
        }

        function updatePhotoStats() {
            document.getElementById('dashTotalPhotos').textContent = progressPhotos.length;
        }

        function deletePhoto(photoId) {
            if (!confirm('Are you sure you want to delete this photo?')) {
                return;
            }

            progressPhotos = progressPhotos.filter(p => p.id !== photoId);
            localStorage.setItem(`photos_${currentUser.email}`, JSON.stringify(progressPhotos));
            renderPhotos();
            updatePhotoStats();
        }

        function openPhotoModal(imageData) {
            document.getElementById('modalImage').src = imageData;
            document.getElementById('photoModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('photoModal').classList.remove('active');
        }

        // Initialize
        window.onload = function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.onboardingComplete) {
                    loadDashboard();
                    showPage('dashboard');
                } else {
                    startOnboarding();
                    showPage('onboarding');
                }
            }
            
            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
            
            // PWA Install Prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallPrompt();
            });
            
            function showInstallPrompt() {
                // Only show if user is logged in and on dashboard
                setTimeout(() => {
                    if (currentUser && currentPage === 'dashboard') {
                        const installBanner = document.createElement('div');
                        installBanner.id = 'installBanner';
                        installBanner.innerHTML = `
                            <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #FF6B35 0%, #1a1a1a 100%); color: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 999; max-width: 90%; text-align: center;">
                                <strong>üì± Install THE LAST COACH</strong>
                                <p style="margin: 10px 0; font-size: 14px;">Add to your home screen for easy access!</p>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button onclick="installPWA()" style="background: white; color: #FF6B35; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">Install</button>
                                    <button onclick="dismissInstallPrompt()" style="background: transparent; color: white; border: 2px solid white; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">Later</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(installBanner);
                    }
                }, 3000); // Show after 3 seconds
            }
            
            window.installPWA = async function() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    deferredPrompt = null;
                    dismissInstallPrompt();
                }
            };
            
            window.dismissInstallPrompt = function() {
                const banner = document.getElementById('installBanner');
                if (banner) {
                    banner.remove();
                }
            };
        };

        // Settings Functions
        function showSettings() {
            document.getElementById('settingsEmail').textContent = currentUser.email;
            document.getElementById('settingsMemberSince').textContent = new Date(currentUser.createdAt).toLocaleDateString();
            document.getElementById('settingsModal').classList.add('active');
            
            // Hide password change section by default
            document.getElementById('passwordChangeSection').style.display = 'none';
            document.getElementById('changePasswordBtn').style.display = 'block';
            
            // Show admin controls only for admin
            if (currentUser.isAdmin) {
                document.getElementById('adminDeleteSection').style.display = 'block';
                loadPendingUsers();
            } else {
                document.getElementById('adminDeleteSection').style.display = 'none';
            }
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            if (document.getElementById('deleteUserEmail')) {
                document.getElementById('deleteUserEmail').value = '';
                document.getElementById('makeAdminEmail').value = '';
                document.getElementById('lockUserEmail').value = '';
            }
            document.getElementById('settingsError').style.display = 'none';
            document.getElementById('settingsSuccess').style.display = 'none';
        }

        function showPasswordChange() {
            document.getElementById('passwordChangeSection').style.display = 'block';
            document.getElementById('changePasswordBtn').style.display = 'none';
            document.getElementById('settingsError').style.display = 'none';
            document.getElementById('settingsSuccess').style.display = 'none';
        }

        function cancelPasswordChange() {
            document.getElementById('passwordChangeSection').style.display = 'none';
            document.getElementById('changePasswordBtn').style.display = 'block';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('settingsError').style.display = 'none';
            document.getElementById('settingsSuccess').style.display = 'none';
        }

        function deleteUser() {
            const emailToDelete = document.getElementById('deleteUserEmail').value.trim();
            
            if (!emailToDelete) {
                showSettingsError('Please enter a user email');
                return;
            }

            if (emailToDelete === currentUser.email) {
                showSettingsError('You cannot delete your own admin account');
                return;
            }

            if (emailToDelete === 'admin@thelastcoach.com') {
                showSettingsError('Cannot delete the main admin account');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');

            if (!users[emailToDelete]) {
                showSettingsError('User not found');
                return;
            }

            if (confirm(`Are you sure you want to delete user: ${emailToDelete}?\n\nThis will delete:\n- User account\n- All progress photos\n- All messages\n- All data\n\nThis action cannot be undone!`)) {
                // Delete user data
                delete users[emailToDelete];
                localStorage.setItem('users', JSON.stringify(users));

                // Delete associated data
                localStorage.removeItem(`photos_${emailToDelete}`);
                localStorage.removeItem(`messages_${emailToDelete}`);
                localStorage.removeItem(`comments_${emailToDelete}`);

                showSettingsSuccess(`User ${emailToDelete} has been deleted successfully`);
                document.getElementById('deleteUserEmail').value = '';
            }
        }

        function makeAdmin() {
            const emailToPromote = document.getElementById('makeAdminEmail').value.trim();
            
            if (!emailToPromote) {
                showSettingsError('Please enter a user email');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');

            if (!users[emailToPromote]) {
                showSettingsError('User not found');
                return;
            }

            if (users[emailToPromote].isAdmin) {
                showSettingsError('User is already an admin');
                return;
            }

            if (!users[emailToPromote].approved) {
                showSettingsError('User must be approved first');
                return;
            }

            if (confirm(`Are you sure you want to promote ${emailToPromote} to admin?\n\nThey will be able to:\n- Delete users\n- Approve/reject users\n- Lock accounts\n- Promote other admins`)) {
                users[emailToPromote].isAdmin = true;
                localStorage.setItem('users', JSON.stringify(users));

                showSettingsSuccess(`${emailToPromote} is now an admin!`);
                document.getElementById('makeAdminEmail').value = '';
            }
        }

        function toggleLockUser() {
            const emailToLock = document.getElementById('lockUserEmail').value.trim();
            
            if (!emailToLock) {
                showSettingsError('Please enter a user email');
                return;
            }

            if (emailToLock === currentUser.email) {
                showSettingsError('You cannot lock your own account');
                return;
            }

            if (emailToLock === 'admin@thelastcoach.com') {
                showSettingsError('Cannot lock the main admin account');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');

            if (!users[emailToLock]) {
                showSettingsError('User not found');
                return;
            }

            const isCurrentlyLocked = users[emailToLock].locked || false;
            users[emailToLock].locked = !isCurrentlyLocked;
            localStorage.setItem('users', JSON.stringify(users));

            const status = users[emailToLock].locked ? 'locked' : 'unlocked';
            showSettingsSuccess(`Account ${emailToLock} has been ${status}`);
            document.getElementById('lockUserEmail').value = '';
        }

        function loadPendingUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const pendingUsers = Object.keys(users).filter(email => 
                !users[email].approved && !users[email].isAdmin
            );

            const pendingList = document.getElementById('pendingUsersList');

            if (pendingUsers.length === 0) {
                pendingList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No pending users</p>';
                return;
            }

            pendingList.innerHTML = pendingUsers.map(email => {
                const user = users[email];
                return `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #FF6B35;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <strong style="color: #333;">${email}</strong><br>
                                <small style="color: #999;">Signed up: ${new Date(user.createdAt).toLocaleDateString()}</small>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="approveUser('${email}')" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">‚úì Approve</button>
                                <button onclick="rejectUser('${email}')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">‚úó Reject</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function approveUser(email) {
            if (confirm(`Approve user: ${email}?`)) {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                if (users[email]) {
                    users[email].approved = true;
                    localStorage.setItem('users', JSON.stringify(users));
                    showSettingsSuccess(`User ${email} approved!`);
                    loadPendingUsers();
                }
            }
        }

        function rejectUser(email) {
            if (confirm(`Reject and delete user: ${email}?\n\nThis will permanently delete their account.`)) {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                if (users[email]) {
                    delete users[email];
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    // Delete associated data
                    localStorage.removeItem(`photos_${email}`);
                    localStorage.removeItem(`messages_${email}`);
                    localStorage.removeItem(`comments_${email}`);
                    
                    showSettingsSuccess(`User ${email} rejected and deleted`);
                    loadPendingUsers();
                }
            }
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            // Hide previous messages
            document.getElementById('settingsError').style.display = 'none';
            document.getElementById('settingsSuccess').style.display = 'none';

            // Validate inputs
            if (!currentPassword || !newPassword || !confirmPassword) {
                showSettingsError('Please fill in all fields');
                return;
            }

            if (currentPassword !== currentUser.password) {
                showSettingsError('Current password is incorrect');
                return;
            }

            if (newPassword.length < 6) {
                showSettingsError('New password must be at least 6 characters');
                return;
            }

            if (newPassword !== confirmPassword) {
                showSettingsError('New passwords do not match');
                return;
            }

            if (currentPassword === newPassword) {
                showSettingsError('New password must be different from current password');
                return;
            }

            // Update password
            currentUser.password = newPassword;
            
            // Update in localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Update in users database
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[currentUser.email]) {
                users[currentUser.email].password = newPassword;
                localStorage.setItem('users', JSON.stringify(users));
            }

            // Show success
            showSettingsSuccess('Password updated successfully!');

            // Hide password form and show button after 2 seconds
            setTimeout(() => {
                cancelPasswordChange();
            }, 2000);
        }

        function showSettingsError(message) {
            const errorEl = document.getElementById('settingsError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showSettingsSuccess(message) {
            const successEl = document.getElementById('settingsSuccess');
            successEl.textContent = message;
            successEl.style.display = 'block';
        }
    </script>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" onclick="closeSettingsModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
            <div style="background: white; padding: 30px; border-radius: 15px; max-height: 80vh; overflow-y: auto;">
                <h2 style="color: #FF6B35; margin-bottom: 20px;">‚öôÔ∏è Account Settings</h2>
                
                <div id=\"settingsError\" class=\"error-message\"></div>
                <div id=\"settingsSuccess\" style=\"background: #d4edda; color: #155724; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none;"></div>
                
                <!-- Password Change Section (hidden by default) -->
                <div id="passwordChangeSection" style="display: none;">
                    <h3 style="color: #333; margin-bottom: 15px;">Change Password</h3>
                    
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" placeholder="Enter current password">
                    </div>

                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password" minlength="6">
                    </div>

                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" placeholder="Confirm new password" minlength="6">
                    </div>

                    <button class="btn" onclick="changePassword()">Update Password</button>
                    <button class="btn btn-secondary" onclick="cancelPasswordChange()" style="margin-top: 10px;">Cancel</button>
                    
                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                </div>
                
                <h3 style="color: #333; margin-bottom: 15px;">Account Management</h3>
                
                <button class="btn" onclick="showPasswordChange()" id="changePasswordBtn" style="background: #6c757d; margin-bottom: 15px;">üîí Change Password</button>
                
                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                
                <h3 style="color: #333; margin-bottom: 15px;">Account Information</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                    <strong>Email:</strong> <span id="settingsEmail"></span><br>
                    <strong>Member Since:</strong> <span id="settingsMemberSince"></span>
                </div>

                <!-- Admin Only: Delete User -->
                <div id="adminDeleteSection" style="display: none; margin-top: 30px;">
                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                    
                    <h3 style="color: #FF6B35; margin-bottom: 20px;">üëë Admin Controls</h3>
                    
                    <!-- Make Admin -->
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                        <h4 style="color: #2196F3; margin-bottom: 15px;">üëë Promote to Admin</h4>
                        <div class="form-group">
                            <label>User Email</label>
                            <input type="email" id="makeAdminEmail" placeholder="Enter user email to promote">
                        </div>
                        <button class="btn" onclick="makeAdmin()" style="background: #2196F3;">Make Admin</button>
                    </div>

                    <!-- Lock/Unlock Account -->
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #f57c00; margin-bottom: 15px;">üîí Lock/Unlock Account</h4>
                        <div class="form-group">
                            <label>User Email</label>
                            <input type="email" id="lockUserEmail" placeholder="Enter user email">
                        </div>
                        <button class="btn" onclick="toggleLockUser()" style="background: #ffc107; color: #000;">Lock/Unlock Account</button>
                    </div>

                    <!-- Delete User -->
                    <div style="background: #ffebee; padding: 20px; border-radius: 10px; border-left: 4px solid #dc3545;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">üóëÔ∏è Delete User</h4>
                        <div class="form-group">
                            <label>User Email</label>
                            <input type="email" id="deleteUserEmail" placeholder="Enter user email to delete">
                        </div>
                        <button class="btn" onclick="deleteUser()" style="background: #dc3545;">Delete User Account</button>
                    </div>

                    <!-- Pending Users Approval -->
                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                    <h4 style="color: #FF6B35; margin-bottom: 15px;">‚úã Pending User Approvals</h4>
                    <div id="pendingUsersList" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #999;">Loading pending users...</p>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="closeSettingsModal()" style="margin-top: 20px;">Close</button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal" onclick="closePhotoModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closePhotoModal()">√ó</button>
            <img id="modalImage" src="" alt="Progress Photo">
        </div>
    </div>
</body>
</html>
